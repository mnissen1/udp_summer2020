---
title: "SGC Propensity Score Matching Report"
author: "Matt Alvarez-Nissen"
date: 'August 18, 2020'
header-includes:
  - \usepackage{indentfirst}
output: 
  pdf_document:
    toc: true
urlcolor: blue
indent: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-libraries-parameters, echo=FALSE, message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(leaps)
library(knitr)
library(kableExtra)
library(gridExtra)
library(magick)

# Directories: 
homedir <- "E:/udp_summer2020/"
workdir <- "sgc_data/raw/"
savedir <- "sgc_data/cleaned/"

# Files
psm_matched_fresno_file <- paste0(homedir, savedir, "psm_matched_fresno.csv")

psm_matched_la_file <- paste0(homedir, savedir, "psm_matched_la.csv")

psm_matched_sf_file <- paste0(homedir, savedir, "psm_matched_sf.csv")

## paths for .csv versions of the NOAH data
noah_16_file <- paste0(homedir, workdir, "NOAH_SGC_2016.csv")

noah_09_file <- paste0(homedir, workdir, "NOAH_SGC_2009.csv")

crosswalk_00_10_file <- paste0(homedir, workdir, "crosswalk_2000_2010.csv")

## Outmigration block group data 
### all
outmigration_all_bg_file <- 
  paste0(homedir, "infogroup_data/outmigration_all_bg.csv")
### LI
outmigration_li_bg_file <- 
  paste0(homedir, "infogroup_data/outmigration_LI_bg.csv")
### renter
outmigration_renters_bg_file <- 
  paste0(homedir, "infogroup_data/outmigration_renters_bg.csv")
### LI renter
outmigration_li_renters_bg_file <- 
  paste0(homedir, "infogroup_data/outmigration_LI_renter_bg.csv")

# Source
source(paste0(homedir, "scripts_analysis/psm_writeup_funcs.R"))
```

# EXECUTIVE SUMMARY

This report details the initial findings of the Urban Displacement Project's (UDP) "Examining the unintended effects of climate change mitigation: a new tool to predict investment-related displacement" funded by the Strategic Growth Council in partnership with Stanford University, Federal Reserve Bank of San Francisco, Public Advocates, Public Counsel, California Housing Partnership and Leadership Counsel. More information on the scope of the project and UDP can be found on their [website](https://www.urbandisplacement.org/current-projects#section-191).

The overall aim of this project is to balance the need for climate change-related investments with the increasing pressures of displacement that low-income communities and communities of color across California face. While the final result will be a tool to help policymakers mitigate displacement impacts for future investments, the following results of this report can help shed some light on how prior investments have already left an impact. Using outmigration data sourced from InfoGroup and UDP's naturally occurring affordable housing (NOAH) dataset, it is possible to measure displacement through high outmigration rates (broken down by income and renter status) and neighborhood exclusion through the loss of NOAH units. Outmigration rates by year from 2007 to 2018 and percentage change in NOAH units from 2009 to 2016 are considered.

To understand the relationship between displacement and climate change-related investments, it is necessary to compare how neighborhoods with and without investments have changed over time. This study looks specifically at neighborhoods in the San Francisco Bay Area, Fresno County, and Los Angeles County. After consultation with partners and stakeholders, investments from four categories - greening, transit, urban infill, and transportation - were chosen. Then, these investments were matched to neighborhoods - defined as 2010 Census tracts.

Making appropriate neighborhood comparisons requires that mitigating factors beyond the investment itself are controlled for. Ultimately, we decided to use propensity score matching (PSM) in order to connect investment and non-investment neighborhoods. PSM is a statistical matching technique that generates a composite score for control and treatment subjects (in this case non-investment tracts and investment tract, respectively) based on shared characteristics. For our purposes, those shared characteristics were ACS demographic data - using common gentrification metrics of the proportion of people of color, college-educated people, and renter-occupied housing units in a neighborhood, as well as median income and median rent, during the baseline year of 2009.

In this report, it is possible to see clear patterns develop with respect to the influence of climate change-related investments. The analysis is thus broken down by total patterns, patterns by investment type, and patterns across the three study regions. While it is not yet possible to make definitive conclusions about the significance of these patterns, this report can serve as a useful guide in understanding the emerging trends. Overall, it appears that between similar neighborhoods the presence of investments can _reduce_ displacement pressures. There are, of course, some caveats to this result. First, all investment types except for urban infill saw an increase in NOAH units (which implies reduced exclusion). Next, while investments overall saw reduced outmigration rates for low-income people, renters, and low-income renters, it did show relatively increased outmigration rates overall. Also, greening investments have a _higher_ outmigration rate for renters while transit investments have _higher_ outmigration rates across all migration groups. Finally, each study area has slightly different results due to context specific factors.

The next steps in determining the significance of these results includes developing comprehensive regression models that account for additional factors. A preliminary draft report of these regressions is currently available, but it is not yet definitive. Additionally, an interactive map is available to visualize the neighborhood matching process and results.

\pagebreak

# Data Cleaning and PSM summary

The following visualizations and regressions rely on matched pairs of neighborhoods with investments and those without investments. Matched pairs are generated using Propensity Score Matching (PSM) - with `invest_psm.R` and its source code `psm_funcs.R`. In order to create the matched pairs, investments must be first matched to 2010 boundary Census tracts using `invest_nbr_match.R`. Next, investment-flagged Census tracts must be joined with 2009 and 2018 ACS data with `invest_nbr_traits.R` (2009 ACS data is crosswalked to 2010 boundaries in `acs_xwalk_00_10.R`). The final result of this process is the .csv file `master_investments_traits.csv`.

`master_investments_traits.csv` is used by `invest_psm.R` to generate matched pairs. In order to determine the most suitable set of covariates to match on, a covariate table with multiple different combinations is created. Each combination goes through the PSM process and generates an average absolute standardized difference (AASD) as a measure of covariate balance. The mean AASD across study region is then determined, and the set of variables with lowest mean AASD is chosen as the final set of covariates. The set chosen includes the 2009 baseline proportions for the nonwhite population, college-educated population, and renter-occupied housing units, as well as 2009 baseline measurements of median income and median rent.

Finally, based on the aforementioned covariates, PSM is carried out based on investment flags by study area (LA, SF Bay Area, and Fresno) and tables of matched pairs are generated (`psm_matched_la.csv`, `psm_matched_sf.csv`, and  `psm_matched_fresno.csv`, respectively). From these tables, descriptive statistics are then developed - as well as accompanying plots and regressions (shown below).

# Descriptive Statistics Summary

`sgc_psm_report.Rmd`, which uses the source code `psm_writeup_funcs.R`, generates descriptive statistics and visualizations (this document). Each study area's matched pairs table is joined into a single table with a study area flag. Additionally, 2009 NOAH data must be crosswalked to 2010 Census boundaries. Next, outmigration block group level data from the InfoGroup dataset is read in - using the "all", "low income", "renters", and "low income renters" datasets. This data must be cleaned and summarized at the tract level for comparison.

As will be seen below, each level of study generates descriptive statistics, visualizations from a NOAH investigation, and visualizations from an outmigration investigation. Analyses are broken into `TOTAL`, `INVESTMENT TYPE` (which is `TOTAL` summarized by investment type flags), `LOS ANGELES`, `FRESNO`, and `SF BAY AREA` levels. The implications of the findings for each analysis will be summarized at the beginning of each study level. See the separate `SGC Full Regressions` report for the full regression models.

\pagebreak

```{r read-area-files, echo=FALSE, warning=FALSE, message=FALSE}
# Read in area files
psm_matched_la <-
  read_csv(psm_matched_la_file, col_types = cols(.default = "c"))
psm_matched_fresno <-
  read_csv(psm_matched_fresno_file, col_types = cols(.default = "c"))
psm_matched_sf <-
  read_csv(psm_matched_sf_file, col_types = cols(.default = "c"))
```

```{r combine-area-files, echo=FALSE, warning=FALSE, message=FALSE}
# Combine area files
psm_matched_total <-
  psm_matched_la %>%
  bind_rows(psm_matched_sf, psm_matched_fresno)
```

```{r read-noah-files, echo=FALSE, warning=FALSE, message=FALSE}
# Read in NOAH data (2016)
noah_16 <-
  read_csv(noah_16_file) %>%
  # filter down to necessary columns
  select(
    GEOID = stctytrct,
    noah_housing_tot = housing_tot,
    noah_tot_clean,
    noah_nolihtc_clean,
    d_bay,
    d_la,
    d_fresno
  )

# Read in NOAH data (2009)
noah_09 <-
  read_csv(noah_09_file) %>%
  # filter down to necessary columns
  select(
    GEOID = stctytrct,
    noah_housing_tot = housing_tot,
    noah_tot_clean,
    noah_nolihtc_clean,
    d_bay,
    d_la,
    d_fresno
  )
```

```{r read-crosswalk-file, echo=FALSE, warning=FALSE, message=FALSE}
# Crosswalk 2009 NOAH to 2010 Census boundaries
## Read in crosswalk file
crosswalk_00_10 <- read_csv(crosswalk_00_10_file)
```

```{r filter-crosswalk, echo=FALSE, warning=FALSE, message=FALSE}
## Filter crosswalk to relevant tract IDs
### Use crosswalk filter from Brown University Diversity and Disparities
### https://s4.ad.brown.edu/projects/diversity/Researcher/LTBDDload/DataList.aspx

# 2009 NOAH
## Create list of FIPS from ACS data to filter on
fips_09_filter <-
  paste(noah_09$GEOID, collapse = "|")

## Filter crosswalk data by relevant FIPS
crosswalk_09_filter <-
  crosswalk_00_10 %>%
  filter(str_detect(trtid00, fips_09_filter))
```

```{r do-crosswalk, echo=FALSE, warning=FALSE, message=FALSE}
# 2009 NOAH
## Interpolate 2000 boundary data to 2010 tracts
noah_09_xwalk <-
  noah_09 %>%
  # rename full FIPS code for a join
  rename(trtid00 = GEOID) %>%
  # join to filtered crosswalk
  full_join(crosswalk_09_filter, by = "trtid00") %>%
  # change weight from character to numeric type
  mutate(weight = as.numeric(weight)) %>%
  # multiply all data by its weight
  mutate(
    across(
      # select all NOAH data
      noah_housing_tot:noah_nolihtc_clean,
      # find value of data multiplied by weight
      ~ . * weight,
      # attach name in the following pattern
      .names = "{col}_09"
    )
  ) %>%
  # select for relevant variables (2010 tracts)
  select(trtid10, ends_with("_09")) %>%
  # group by 2010 tracts
  group_by(trtid10) %>%
  # sum up all variables
  summarise_all(sum) %>%
  # rename trtid10 to GEOID
  rename(GEOID = trtid10)

# drop unneeded data
rm(noah_09, crosswalk_00_10, crosswalk_09_filter)
```

```{r read-outmigration-files, echo=FALSE, warning=FALSE, message=FALSE}
# Read in outmigration data
# all
outmigration_all_bg <-
  read_csv(outmigration_all_bg_file) %>%
  # create tract code to sum up to
  mutate(
    GEOID10 = as.character(GEOID10),
    tract = str_extract(GEOID10, "^\\d{10}"),
    tract = str_pad(tract, 11, "0", side = "left")
  )

# low income
outmigration_li_bg <-
  read_csv(outmigration_li_bg_file) %>%
  # create tract code to sum up to
  mutate(
    GEOID10 = as.character(GEOID10),
    tract = str_extract(GEOID10, "^\\d{10}"),
    tract = str_pad(tract, 11, "0", side = "left")
  )

# renters
outmigration_renters_bg <-
  read_csv(outmigration_renters_bg_file) %>%
  # create tract code to sum up to
  mutate(
    GEOID10 = as.character(GEOID10),
    tract = str_extract(GEOID10, "^\\d{10}"),
    tract = str_pad(tract, 11, "0", side = "left")
  )

# LI renters
outmigration_li_renters_bg <-
  read_csv(outmigration_li_renters_bg_file) %>%
  # create tract code to sum up to
  mutate(
    GEOID10 = as.character(GEOID10),
    tract = str_extract(GEOID10, "^\\d{10}"),
    tract = str_pad(tract, 11, "0", side = "left")
  )
```

```{r filter-outmigration, echo=FALSE, warning=FALSE, message=FALSE}
# Filter outmigration to study area, then sum up to tract level
# all
outmigration_all_tract <-
  outmigration_all_bg %>%
  # Sum up data to tract level
  group_by(tract) %>%
  summarize(
    across(
      .cols = starts_with("num_"),
      # remove NAs
      .fns = ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # determine outmigration rates
  mutate(
    outmigration_all_2007 = num_out_2007 / num_fams_2006,
    outmigration_all_2008 = num_out_2008 / num_fams_2007,
    outmigration_all_2009 = num_out_2009 / num_fams_2008,
    outmigration_all_2010 = num_out_2010 / num_fams_2009,
    outmigration_all_2011 = num_out_2011 / num_fams_2010,
    outmigration_all_2012 = num_out_2012 / num_fams_2011,
    outmigration_all_2013 = num_out_2013 / num_fams_2012,
    outmigration_all_2014 = num_out_2014 / num_fams_2013,
    outmigration_all_2015 = num_out_2015 / num_fams_2014,
    outmigration_all_2016 = num_out_2016 / num_fams_2015,
    outmigration_all_2017 = num_out_2017 / num_fams_2016,
    outmigration_all_2018 = num_out_2018 / num_fams_2017
  )

# low income
outmigration_li_tract <-
  outmigration_li_bg %>%
  # Sum up data to tract level
  group_by(tract) %>%
  summarize(
    across(
      .cols = starts_with("num_"),
      # remove NAs
      .fns = ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # determine outmigration rates
  mutate(
    outmigration_LI_2007 = num_out_LI_2007 / num_fams_LI_2006,
    outmigration_LI_2008 = num_out_LI_2008 / num_fams_LI_2007,
    outmigration_LI_2009 = num_out_LI_2009 / num_fams_LI_2008,
    outmigration_LI_2010 = num_out_LI_2010 / num_fams_LI_2009,
    outmigration_LI_2011 = num_out_LI_2011 / num_fams_LI_2010,
    outmigration_LI_2012 = num_out_LI_2012 / num_fams_LI_2011,
    outmigration_LI_2013 = num_out_LI_2013 / num_fams_LI_2012,
    outmigration_LI_2014 = num_out_LI_2014 / num_fams_LI_2013,
    outmigration_LI_2015 = num_out_LI_2015 / num_fams_LI_2014,
    outmigration_LI_2016 = num_out_LI_2016 / num_fams_LI_2015,
    outmigration_LI_2017 = num_out_LI_2017 / num_fams_LI_2016,
    outmigration_LI_2018 = num_out_LI_2018 / num_fams_LI_2017
  )

# renters
outmigration_renters_tract <-
  outmigration_renters_bg %>%
  # Sum up data to tract level
  group_by(tract) %>%
  summarize(
    across(
      .cols = starts_with("num_"),
      # remove NAs
      .fns = ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # change names to specify renters for later join
  rename_with(~ str_replace(., "_out_", "_out_r_")) %>%
  rename_with(~ str_replace(., "_fams_", "_fams_r_")) %>%
  # determine outmigration rates
  mutate(
    outmigration_renters_2007 = num_out_r_2007 / num_fams_r_2006,
    outmigration_renters_2008 = num_out_r_2008 / num_fams_r_2007,
    outmigration_renters_2009 = num_out_r_2009 / num_fams_r_2008,
    outmigration_renters_2010 = num_out_r_2010 / num_fams_r_2009,
    outmigration_renters_2011 = num_out_r_2011 / num_fams_r_2010,
    outmigration_renters_2012 = num_out_r_2012 / num_fams_r_2011,
    outmigration_renters_2013 = num_out_r_2013 / num_fams_r_2012,
    outmigration_renters_2014 = num_out_r_2014 / num_fams_r_2013,
    outmigration_renters_2015 = num_out_r_2015 / num_fams_r_2014,
    outmigration_renters_2016 = num_out_r_2016 / num_fams_r_2015,
    outmigration_renters_2017 = num_out_r_2017 / num_fams_r_2016,
    outmigration_renters_2018 = num_out_r_2018 / num_fams_r_2017
  )

# LI renters
outmigration_li_renters_tract <-
  outmigration_li_renters_bg %>%
  # Sum up data to tract level
  group_by(tract) %>%
  summarize(
    across(
      .cols = starts_with("num_"),
      # remove NAs
      .fns = ~ sum(., na.rm = TRUE)
    )
  ) %>%
  # change names to specify renters for later join
  rename_with(~ str_replace(., "_out_LI", "_out_LI_r")) %>%
  rename_with(~ str_replace(., "_fams_LI", "_fams_LI_r")) %>%
  # determine outmigration rates
  mutate(
    outmigration_LI_renters_2007 = num_out_LI_r_2007 / num_fams_LI_r_2006,
    outmigration_LI_renters_2008 = num_out_LI_r_2008 / num_fams_LI_r_2007,
    outmigration_LI_renters_2009 = num_out_LI_r_2009 / num_fams_LI_r_2008,
    outmigration_LI_renters_2010 = num_out_LI_r_2010 / num_fams_LI_r_2009,
    outmigration_LI_renters_2011 = num_out_LI_r_2011 / num_fams_LI_r_2010,
    outmigration_LI_renters_2012 = num_out_LI_r_2012 / num_fams_LI_r_2011,
    outmigration_LI_renters_2013 = num_out_LI_r_2013 / num_fams_LI_r_2012,
    outmigration_LI_renters_2014 = num_out_LI_r_2014 / num_fams_LI_r_2013,
    outmigration_LI_renters_2015 = num_out_LI_r_2015 / num_fams_LI_r_2014,
    outmigration_LI_renters_2016 = num_out_LI_r_2016 / num_fams_LI_r_2015,
    outmigration_LI_renters_2017 = num_out_LI_r_2017 / num_fams_LI_r_2016,
    outmigration_LI_renters_2018 = num_out_LI_r_2018 / num_fams_LI_r_2017
  )

# join all variations together
outmigration_tract <-
  outmigration_all_tract %>%
  left_join(outmigration_li_tract, by = "tract") %>%
  left_join(outmigration_renters_tract, by = "tract") %>%
  left_join(outmigration_li_renters_tract, by = "tract") %>%
  # Filter to study tracts
  mutate(study_tract = if_else(tract %in% psm_matched_total$GEOID, 1, 0))
```

```{r write-outmigration-tract-master}
# create master save version of outmigration tracts
outmigration_tract_save <- outmigration_tract

# remove non-study tracts
outmigration_tract <-
  outmigration_tract %>%
  filter(study_tract == 1) %>%
  # remove flag
  select(-study_tract)

# remove unneeded outmigration data
rm(
  outmigration_all_bg, outmigration_li_bg, outmigration_li_renters_bg,
  outmigration_renters_bg, outmigration_all_tract, outmigration_li_tract,
  outmigration_li_renters_tract, outmigration_renters_tract
)
```

# TOTAL
## Summary
* __NOAH__: When considering total NOAH units, the investigation shows that neighborhoods without investments saw a slower increase in the quantity of NOAH units between 2009 and 2016 than did neighborhoods with. This trend is largely maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive relationship with NOAH units (although this is not statistically significant). Tthis trend is maintained when considering only non-LIHTC units (this is statistically significant at p<0.05).

* __Outmigration__
    + `Outmigration All`: The time series plot shows that generally higher outmigration rates are associated with investments, which the bar plot confirms. A linear regression maintains this observation - demonstrating about a 1.1% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
    + `Outmigration Low Income`: The time series plot shows a variable relationship between outmigration rates and investments, while the bar plot shows a slightly negative relationship. A linear regression demonstrates about a 0.8% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.1).
    + `Outmigration Renters`: The time series plot shows a variable relationship between outmigration rates and investments, while the bar plot shows a slightly megative relationship. A linear regression demonstrates about a 0.2% increase in outmigration with the presence of an investment (this result is not statistically significant).
    + `Outmigration Low Income Renters`: The time series plot shows a variable relationship between outmigration rates and investments, while the bar plot indicates that slightly lower outmigration rates are associated with investments. A linear regression shows about a 0.01% increase in outmigration with the presence of an investment (this result is not statistically significant).

```{r, echo=FALSE, warning=FALSE, message=FALSE}
### Join Investment, NOAH, and Outmigration Data
total_psm <- area_psm(psm_matched_total)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
### Generate Descriptive Stats
total_stats <- area_stats(total_psm)
```

## Summary Tables
```{r}
total_summary <- area_summary(total_psm)
```

```{r}
# Print NOAH Summary Table
noah_summary_table_total <-
  noah_summary_table(
    total_summary,
    "Overall NOAH % Change by Investment Type\n(2009 - 2016)"
  )
noah_summary_table_total
```

```{r}
# Print Outmigration Summary Table
outmigration_summary_table_total <-
  outmigration_summary_table(
    total_summary,
    "Overall Average Outmigration Rate by Investment Type\n(2007 - 2018)"
  )
outmigration_summary_table_total
```

## NOAH Investigation
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
noah_bar_plot(total_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_reg(total_stats, total_psm, reg_output = latex, font_size = "tiny")
```

## Outmigration Investigation
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_time(total_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plot
outmig_bar <- outmigration_bar(total_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 12}
cowplot::plot_grid(
  outmig_time,
  outmig_bar,
  ncol = 1
)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Outmigration regression
outmigration_reg(total_stats, total_psm, latex, "tiny")
```

# INVESTMENT TYPE
## Summary
* `Greening`
    + __NOAH__: The NOAH investigation shows that neighborhoods with greening investments saw a much faster increase in the quantity of NOAH units between 2009 and 2016 than did neighborhoods without. This trend is maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive relationship with NOAH units (this is statistically significant at p<0.01). Again, this trend is maintained when considering only non-LIHTC units (this is statistically significant at p<0.01).
    + __Outmigration__
        - `Outmigration All`: The time series plot shows a generally positive relationship, and the bar plot indicates that higher outmigration rates are associated with greening investments. A linear regression confirms this observation - demonstrating about 1.9% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.05).
        - `Outmigration Low Income`: The time series plot indicates a mixed relationship, which the bar plot confirms. A linear regression also confirms this observation, producing about a 0.2% increase in outmigration with the presence of an investment (this result is not statistically significant).
        - `Outmigration Renters`: The time series plot indicates a variable relationship between greening investments and outmigration, while the bar plot indicates a slight trend towards decreased outmigration in greening investment neighborhoods. A linear regression confirms this observation - demonstrating about 1.4% decrease in outmigration with the presence of an investment (this result is not significant at p<0.1).
        - `Outmigration Low Income Renters`: The time series plot indicates a variable relationship between greening investments and outmigration, which the bar plot confirms. A linear regression demonstrates about 1.8% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.1).

* `Transit`
    + __NOAH__: The NOAH investigation shows that neighborhoods with transit investments saw a higher increase in the quantity of NOAH units between 2009 and 2016 than did neighborhoods without. This trend is maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive relationship with NOAH units (this is not statistically significant). This trend is maintained when considering only non-LIHTC units (this is not statistically significant).
    + __Outmigration__
        - `Outmigration All`: The time series plot shows that generally higher outmigration rates are associated with transit investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 1.9% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Low Income`: The time series plot shows that slightly higher outmigration rates are associated with transit investments, and the bar plot shows a slightly positive relationship. A linear regression also confirms this observation - demonstrating about 2.0% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Renters`: The time series plot shows that slightly higher outmigration rates are associated with transit investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 1.5% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Low Income Renters`: The time series plot shows that a variable relationship between outmigration rates are associated with transit investments, while the bar plot indicates slightly higher outmigration rates. A linear regression also confirms higher outmigration rates - demonstrating about 1.4% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.01).

* `Urban Infill`
    + __NOAH__: The NOAH investigation shows that neighborhoods with urban infill investments saw a decrease in the quantity of NOAH units between 2009 and 2016, while those without saw an increase. This trend is reversed (although the increase for investment neighborhoods is slower than those without) when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a negative relationship with NOAH units (this is not statistically significant). This trend is maintained when considering only non-LIHTC units (this is not statistically significant).
    + __Outmigration__
        - `Outmigration All`: The time series plot shows a mixed relationship between urban infill investments and outmigration, while the bar plot confirms shows a slight trend towards lower rates. A linear regression also demonstrates about a 1.7% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Low Income`: The time series plot shows that generally lower outmigration rates associated with urban infill investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 0.6% decrease in outmigration with the presence of an investment (this result is not statistically significant).
        - `Outmigration Renters`: The time series plot shows that generally lower outmigration rates associated with urban infill investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 1.8% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Low Income Renters`: The time series plot shows that generally lower outmigration rates associated with urban infill investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 2.3% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).

* `Active Transportation`
    + __NOAH__: The NOAH investigation shows that neighborhoods with active transportation investments saw a faster increase in the quantity of NOAH units between 2009 and 2016 than did neighborhoods without. This trend is maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive relationship with NOAH units (this is not statistically significant). This trend is maintained when considering only non-LIHTC units (this is not statistically significant).
    + __Outmigration__
        - `Outmigration All`: The time series plot shows a mixed relationship between  lower outmigration rates and active transportation investments, while the bar plot shows a slight negative trend between them. A linear regression confirms this observation - demonstrating about 0.9% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.05).
        - `Outmigration Low Income`: The time series plot shows that lower outmigration rates associated with active transportation investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 2.8% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Renters`: The time series plot shows that lower outmigration rates associated with active transportation investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 2.9% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
        - `Outmigration Low Income Renters`: The time series plot shows that lower outmigration rates associated with active transportation investments, and the bar plot confirms this. A linear regression also confirms this observation - demonstrating about 3.4% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).

```{r, warning=FALSE, message=FALSE}
### Generate Descriptive Stats per Investment Type
# Greening
greening_stats <- type_stats(total_psm, investment_type = greening)

# Transit
transit_stats <- type_stats(total_psm, investment_type = transit)

# Urban Infill
urban_infill_stats <- type_stats(total_psm, investment_type = urban_infill)

# Active Transportation
active_transportation_stats <-
  type_stats(total_psm, investment_type = active_transportation)
```

## Greening
### NOAH Investigation (GREENING)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.width=12}
noah_type_bar_plot(greening_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_type_reg(greening_stats, total_psm, reg_output = latex)
```

### Outmigration Investigation (GREENING)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_type_time(greening_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plots
outmig_bar <- outmigration_type_bar(greening_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 14}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
outmigration_type_reg(
  greening_stats, total_psm, reg_output = latex, font_size = "tiny"
)
```

## Transit
### NOAH Investigation (TRANSIT)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.width=12}
noah_type_bar_plot(transit_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_type_reg(transit_stats, total_psm, reg_output = latex)
```

### Outmigration Investigation (TRANSIT)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_type_time(transit_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plots
outmig_bar <- outmigration_type_bar(transit_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 14}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
outmigration_type_reg(
  transit_stats, total_psm, reg_output = latex, font_size = "tiny"
)
```

## Urban Infill
### NOAH Investigation (URBAN INFILL)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.width=12}
noah_type_bar_plot(urban_infill_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_type_reg(urban_infill_stats, total_psm, reg_output = latex)
```

### Outmigration Investigation (URBAN INFILL)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_type_time(urban_infill_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plots
outmig_bar <- outmigration_type_bar(urban_infill_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 14}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
outmigration_type_reg(
  urban_infill_stats, total_psm, reg_output = latex, font_size = "tiny"
)
```

## Active Transportation
### NOAH Investigation (ACTIVE TRANSPORTATION)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.width=12}
noah_type_bar_plot(active_transportation_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_type_reg(active_transportation_stats, total_psm, reg_output = latex)
```

### Outmigration Investigation (ACTIVE TRANSPORTATION)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_type_time(active_transportation_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plots
outmig_bar <- outmigration_type_bar(active_transportation_stats, total_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 14}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
outmigration_type_reg(
  active_transportation_stats, total_psm, reg_output = latex, font_size = "tiny"
)
```

\pagebreak

# LOS ANGELES
## Summary
* __NOAH__: The LA NOAH investigation shows that neighborhoods with investments saw a slightly higher increase in NOAH units between 2009 and 2016 than did neighborhoods without. This trend is maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive relationship with NOAH units (this is not statistically significant). This trend is reversed when considering only non-LIHTC units (this is not statistically significant). The NOAH summary tables break down this relationship by investment type, and then by the specific investment cases.

* __Outmigration__
    + `Overall Patterns`: See the summary tables for LA outmigration rates, including by investment type and by specific investment. Both tables show neighborhood trends based on the presence of the investment/investment type.
    + `Outmigration All`: Both time series and bar plots indicate generally lower outmigration rates for neighborhoods with investments, while a linear regression demonstrates about a 0.8% decrease (this result is statistically significant at p<0.05).
    + `Outmigration Low Income`: Both time series and bar plots indicate that generally lower outmigration rates are associated with the presence of investments, and a linear regression confirms this relationship with a 0.7% decrease (this result is not statistically significant).
    + `Outmigration Renters`: Both time series and bar plots indicate that generally lower outmigration rates are associated with the presence of investments. However, a linear regression demonstrates about a 0.1% increase (this result is not statistically significant).
    + `Outmigration Low Income Renters`: Both time series and bar plots indicate that lower  outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 0.4% decrease (this result is not statistically significant).

```{r, warning=FALSE, message=FALSE}
### Join Investment and NOAH Data
la_psm <- area_psm(psm_matched_la)
```

```{r, warning=FALSE, message=FALSE}
### Generate Descriptive Stats
la_stats <- area_stats(la_psm)
```

## Summary Tables (LA)
```{r, warning=FALSE, message=FALSE}
la_summary <- area_summary(la_psm)
```

```{r, warning=FALSE, message=FALSE}
# Print NOAH Summary Table
noah_summary_table_la <-
  noah_summary_table(
    la_summary,
    "LA Area NOAH % Change by Investment Type\n(2009 - 2016)"
  )
noah_summary_table_la
```

```{r, warning=FALSE, message=FALSE}
# Print Outmigration Summary Table
outmigration_summary_table_la <-
  outmigration_summary_table(
    la_summary,
    "LA Area Overall Average Outmigration Rate by Investment Type\n(2007 - 2018)"
  )
outmigration_summary_table_la
```

```{r, warning=FALSE, message=FALSE}
# Create investment summary df
la_investment_summary <-
  investment_summary(la_psm, la_stats) %>%
  filter(!str_detect(investment_name, "Tytv "))
```

```{r, warning=FALSE, message=FALSE}
# Print NOAH Summary Table
noah_invest_table_la <-
  noah_summary_table(
    la_investment_summary,
    "LA Area NOAH % Change by Investment\n(2009 - 2016)"
  )
noah_invest_table_la
```

```{r, warning=FALSE, message=FALSE}
# Print outmigration summary table
outmigration_invest_table_la <-
  outmigration_summary_table(
    la_investment_summary,
    "LA Area Overall Average Outmigration Rate by Investment\n(2007 - 2018)"
  )
outmigration_invest_table_la
```

## NOAH Investigation (LA)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
noah_bar_plot(la_stats, la_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_reg(la_stats, la_psm, reg_output = latex, font_size = "tiny")
```

## Outmigration Investigation (LA)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_time(la_stats, la_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plot
outmig_bar <- outmigration_bar(la_stats, la_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 12}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Outmigration regression
outmigration_reg(la_stats, la_psm, latex, "tiny")
```

# FRESNO
## Summary
* __NOAH__: The Fresno NOAH investigation shows that neighborhoods with investments saw a much higher increase in NOAH units between 2009 and 2016 than those without. In fact, no investment neighborhoods saw a decrease. This trend is maintained when considering only non-LIHTC NOAH units. A linear regression demonstrates that the presence of investments indicates a positive change in NOAH units (this is not statistically significant). This trend is maintained when considering only non-LIHTC units (this is statistically significant at p<0.05). The NOAH summary tables break down this relationship by investment type, and then by the specific investment cases.

* __Outmigration__
    + `Overall Patterns`: See the summary tables for Fresno outmigration rates, including by investment type and by specific investment. Both tables show neighborhood trends based on the presence of the investment/investment type.
    + `Outmigration All`: Both time series and bar plots indicate that higher outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 2.8% increase (this result is statistically significant at p<0.01).
    + `Outmigration Low Income`: Both time series and bar plots indicate that higher outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 3.3% increase (this result is statistically significant at p<0.01).
    + `Outmigration Renters`: Both time series and bar plots indicate that higher outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 2.4% increase (this result is statistically significant at p<0.01).
    + `Outmigration Low Income Renters`: Both time series and bar plots indicate that  higher outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 2.6% increase (this result is statistically significant at p<0.01).

```{r, warning=FALSE, message=FALSE}
### Join Investment and NOAH Data
fresno_psm <- area_psm(psm_matched_fresno)
```

```{r, warning=FALSE, message=FALSE}
### Generate Descriptive Stats
fresno_stats <- area_stats(fresno_psm)
```

## Summary Tables (FRESNO)
```{r, warning=FALSE, message=FALSE}
fresno_summary <- area_summary(fresno_psm)
```

```{r, warning=FALSE, message=FALSE}
# Print NOAH Summary Table
noah_summary_table_fresno <-
  noah_summary_table(
    fresno_summary,
    "Fresno Area NOAH % Change by Investment Type\n(2009 - 2016)"
  )
noah_summary_table_fresno
```

```{r, warning=FALSE, message=FALSE}
# Print Outmigration Summary Table
outmigration_summary_table_fresno <-
  outmigration_summary_table(
    fresno_summary,
    "Fresno Area Overall Average Outmigration Rate by Investment Type\n(2007 - 2018)"
  )
outmigration_summary_table_fresno
```

```{r, warning=FALSE, message=FALSE}
# Create investment summary df
fresno_investment_summary <-
  investment_summary(fresno_psm, fresno_stats) %>%
  # Clean up investment names
  mutate(
    investment_name = str_replace(investment_name, " \\(.*\\)", ""),
    investment_name =
      ifelse(
        investment_name %in%
          c(
            "1612 Fulton St ",
            "Brio On Broadway ",
            "Bungalow Court ",
            "Crichton Place ",
            "Fulton Village ",
            "The Lede ",
            "Van Ness Cottages "
          ),
        paste(investment_name, "(Granville Properties)"),
        investment_name
      ),
    investment_name = str_replace(investment_name, "Brt", "BRT")
  )
```

```{r, warning=FALSE, message=FALSE}
# Print NOAH Summary Table
noah_invest_table_fresno <-
  noah_summary_table(
    fresno_investment_summary,
    "Fresno Area NOAH % Change by Investment\n(2009 - 2016)"
  )
noah_invest_table_fresno
```

```{r, warning=FALSE, message=FALSE}
# Print Outmigration Summary Table
outmigration_invest_table_fresno <-
  outmigration_summary_table(
    fresno_investment_summary,
    "Fresno Area Overall Average Outmigration Rate by Investment\n(2007 - 2018)"
  )
outmigration_invest_table_fresno
```

## NOAH Investigation (FRESNO)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
noah_bar_plot(fresno_stats, fresno_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_reg(fresno_stats, fresno_psm, reg_output = latex, font_size = "tiny")
```

## Outmigration Investigation (FRESNO)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_time(fresno_stats, fresno_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plot
outmig_bar <- outmigration_bar(fresno_stats, fresno_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 12}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Outmigration regression
outmigration_reg(fresno_stats, fresno_psm, latex, "tiny")
```

# SF BAY AREA
## Summary
* __NOAH__: The SF Bay Area NOAH investigation shows that neighborhoods with investments saw a higher increase in the quantity of NOAH units between 2009 and 2016 than did neighborhoods without. This trend is maintained when only considering non-LIHTC NOAH units. Conducting a linear regression shows that the presence of investments indicates a positive change in NOAH units (although this is not statistically significant). Again, this trend is maintained when considering only non-LIHTC units (this is statistically significant at p<0.1). The NOAH summary tables break down this relationship by investment type, and then by the specific investment cases.

* __Outmigration__
    + `Overall Patterns`: See the summary tables for SF Bay Area outmigration rates, including by investment type and by specific investment. Both tables show neighborhood trends based on the presence of the investment/investment type.
    + `Outmigration All`: Both time series and bar plots indicate that higher  outmigration rates are generally associated with the presence of investments, and a linear regression confirms this relationship with a 3.9% increase (this result is statistically significant at p<0.01).
    + `Outmigration Low Income`: Both time series and bar plots indicate that lower  outmigration rates are generally associated with the presence of investments. However, a linear regression demonstrates about a 1.7% increase in outmigration with the presence of an investment (this result is statistically significant at p<0.05).
    + `Outmigration Renters`: The time series plot indicates a generally negative relationship between investments and outmigration, and the bar plot indicates a trend towards decreased outmigration in investment neighborhoods. A linear regression confirms this, demonstrating about 1.9% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.01).
    + `Outmigration Low Income Renters`: The time series plot indicates a negative relationship between investments and outmigration, and the bar plot indicates a trend towards decreased outmigration in investment neighborhoods. A linear regression confirms this, demonstrating about 1.5% decrease in outmigration with the presence of an investment (this result is statistically significant at p<0.1).

```{r, warning=FALSE, message=FALSE}
### Join Investment and NOAH Data
sf_psm <- area_psm(psm_matched_sf)
```

```{r, warning=FALSE, message=FALSE}
### Generate Descriptive Stats
sf_stats <- area_stats(sf_psm)
```

## Summary Tables (SF BAY)
```{r, warning=FALSE, message=FALSE}
sf_summary <- area_summary(sf_psm)
```

```{r, warning=FALSE, message=FALSE}
# Print NOAH Summary Table
noah_summary_table_sf <-
  noah_summary_table(
    sf_summary,
    "SF Bay Area NOAH % Change by Investment Type\n(2009 - 2016)"
  )
noah_summary_table_sf
```

```{r, warning=FALSE, message=FALSE}
# Print Outmigration Summary Table
outmigration_summary_table_sf <-
  outmigration_summary_table(
    sf_summary,
    "SF Bay Area Overall Average Outmigration Rate by Investment Type\n(2007 - 2018)"
  )
outmigration_summary_table_sf
```

```{r, warning=FALSE, message=FALSE}
# Create investment summary df
sf_investment_summary <-
  investment_summary(sf_psm, sf_stats) %>%
  # Clean up investment names
  mutate(
    # Consolidate MTV
    investment_name =
      if_else(
        str_detect(investment_name, "^Mtv"),
        "MacArthur Transit Village",
        investment_name
      ),
    # Change Sac Phase 2 Extension name
    investment_name =
      if_else(
        investment_name == "Phase 2 Expansion" ,
        "South Sacramento Corridor Light Rail Extension Phase 2",
        investment_name
      ),
    # Change Concord Blvd name
    investment_name =
      if_else(
        investment_name == "Concord Monument Blvd Ped Imprv" ,
        "Concord Monument Blvd. Pedestrian Infrastructure Improvement Project",
        investment_name
      ),
    # Change San Leandro BART name
    investment_name =
      if_else(
        investment_name == "San Leandro Dt Bart Interface" ,
        "San Leandro Downtown BART Interface",
        investment_name
      ),
    # Change 3rd street light rail name
    investment_name =
      if_else(
        investment_name == "T Third St Light Rail Line" ,
        "SFMTA Third Street Light Rail",
        investment_name
      ),
    # remove &
    investment_name = str_replace_all(investment_name, "&", "and")
  ) %>%
  distinct()
```

```{r, warning=FALSE, message=FALSE}
#Print NOAH Summary Table
noah_invest_table_sf <-
  noah_summary_table(
    sf_investment_summary,
    "SF Bay Area NOAH % Change by Investment\n(2009 - 2016)"
  )
noah_invest_table_sf
```

```{r, warning=FALSE, message=FALSE}
# Print Outmigration Summary Table
outmigration_invest_table_sf <-
  outmigration_summary_table(
    sf_investment_summary,
    "SF Bay Area Overall Average Outmigration Rate by Investment\n(2007 - 2018)"
  )
outmigration_invest_table_sf
```

## NOAH Investigation (SF BAY)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
noah_bar_plot(sf_stats, sf_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Regression
noah_reg(sf_stats, sf_psm, reg_output = latex, font_size = "tiny")
```

## Outmigration Investigation (SF BAY)
```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Time series
outmig_time <- outmigration_time(sf_stats, sf_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
### Bar plot
outmig_bar <- outmigration_bar(sf_stats, sf_psm)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis", fig.height = 10, fig.width = 12}
cowplot::plot_grid(outmig_time, outmig_bar, ncol = 1)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
# Outmigration regression
outmigration_reg(sf_stats, sf_psm, latex, "tiny")
```



```{r write-results, echo=FALSE, warning=FALSE, message=FALSE}
# Write Results
# 2009 NOAH crosswalk 
noah_09_xwalk %>% 
  write_csv(paste0(homedir, savedir, "NOAH_SGC_2009_xwalk.csv"))

# Master outmigration tracts
outmigration_tract_save %>% 
  write_csv(paste0(homedir, "infogroup_data/outmigration_tract_master.csv"))

# Write complete df
total_psm %>% 
  write_csv(paste0(homedir, savedir, "writeup_results/total_stats_all.csv"))

# Write investment stats df for each region
total_stats %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/total_stats_investment.csv")
  )
sf_stats %>%
  write_csv(paste0(homedir, savedir, "writeup_results/sf_stats_investment.csv"))
la_stats %>%
  write_csv(paste0(homedir, savedir, "writeup_results/la_stats_investment.csv"))
fresno_stats %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/fresno_stats_investment.csv")
  )

# Write investment type stats
greening_stats %>%
  write_csv(paste0(homedir, savedir, "writeup_results/greening_stats.csv"))
transit_stats %>%
  write_csv(paste0(homedir, savedir, "writeup_results/transit_stats.csv"))
urban_infill_stats %>%
  write_csv(paste0(homedir, savedir, "writeup_results/urban_infill_stats.csv"))
active_transportation_stats %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/active_transportation_stats.csv")
  )

# Write summary tables
total_summary %>%
  write_csv(paste0(homedir, savedir, "writeup_results/total_summary.csv"))
la_summary %>%
  write_csv(paste0(homedir, savedir, "writeup_results/la_summary.csv"))
fresno_summary %>%
  write_csv(paste0(homedir, savedir, "writeup_results/fresno_summary.csv"))
sf_summary %>%
  write_csv(paste0(homedir, savedir, "writeup_results/sf_summary.csv"))
## investments
la_investment_summary %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/la_investment_summary.csv")
  )
fresno_investment_summary %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/fresno_investment_summary.csv")
  )
sf_investment_summary %>%
  write_csv(
    paste0(homedir, savedir, "writeup_results/sf_investment_summary.csv")
  )
```

```{r save-kables, eval=FALSE}
setwd(homedir)
# save NOAH total kable
noah_summary_table_total %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_summary_table_total.png"
  )

# save Outmigration total kable
outmigration_summary_table_total %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_summary_table_total.png"
  )

# save NOAH LA kable
noah_summary_table_la %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_summary_table_la.png"
  )

# save Outmigration LA kable
outmigration_summary_table_la %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_summary_table_la.png"
  )

# save investment NOAH LA kable
noah_invest_table_la %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_investments_table_la.png"
  )

# save investment Outmigration LA kable
outmigration_invest_table_la %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_investments_table_la.png"
  )

# save NOAH Fresno kable
noah_summary_table_fresno %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_summary_table_fresno.png"
  )

# save outmigration Fresno kable
outmigration_summary_table_fresno %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_summary_table_fresno.png"
  )

# save investment NOAH Fresno kable
noah_invest_table_fresno %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_investments_table_fresno.png"
  )

# save investment outmigration Fresno kable
outmigration_invest_table_fresno %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_investments_table_fresno.png"
  )

# save NOAH SF kable
noah_summary_table_sf %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_summary_table_sf.png"
  )

# save outmigration SF kable
outmigration_summary_table_sf %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_summary_table_sf.png"
  )

# save investment NOAH SF kable
noah_invest_table_sf %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/noah_investments_table_sf.png"
  )

# save investment outmigration SF kable
outmigration_invest_table_sf %>%
  save_kable(
    "visualizations/psm_writeup/summary_tables/outmigration_investments_table_sf.png"
  )
```