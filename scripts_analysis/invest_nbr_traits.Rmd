---
title: "Investment Tract Characteristics"
author: "Matt Alvarez-Nissen"
date: "June 29, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set working directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
library(tidyverse)
library(glue)
library(tidycensus)
library(tigris)
library(sf)
options(tigris_use_cache = TRUE)

# Files
investment_tract_file <- "./SGC/investment_tract.csv"

acs_tract_09_xwalk_file <- "./SGC/acs_tract_09_xwalk.csv"

acs_tract_18_file <- "./SGC/acs_tract_18.csv"

# Parameters
sf_bay_area <- 
  c(
    "Alameda", "Contra Costa", "Marin", "Napa", "Sacramento", "San Francisco", "San Joaquin", "San Mateo", "Santa Clara", "Santa Cruz", "Solano", "Yolo")

census_year <- 2010

master_df_path <- "./SGC/master_investments.csv"

master_09_df_path <- "./SGC/master_investments_09.csv"

acs_tract_18_filter_path <- "./SGC/acs_tract_18_filter.csv"
```

# Read in investment tracts
```{r}
investment_tract <- 
  read_csv(investment_tract_file) 
```

# Read in all study area tracts (LA, Fresno, SF Bay)
```{r}
# Use 2010 Census for comparison (will crosswalk ACS data)
study_tracts <-
  # study area depends on year
  tracts(
    state = "CA",
    county = c("Los Angeles", "Fresno", sf_bay_area),
    year = census_year
  ) %>% 
  st_as_sf() %>% 
  select(GEOID = GEOID10, geometry)
```

# Join investment and study tracts
```{r}
# join the two files together
study_invest_join <-
  study_tracts %>% 
  left_join(investment_tract, by = "GEOID") %>% 
  #turn into tibble for easier manipulation
  tibble() %>% 
  mutate(row_id = row_number())

# generate list for investment flag
invest_true <-
  study_invest_join %>%
  select(row_id, contains("investment")) %>% 
  filter(!is.na(investment_1))

# include investment flag, intervention flag, 
# and investment count to create master_df
master_df <-
  study_invest_join %>% 
  mutate(
    # create investment flag
    investment = 
      if_else(
        study_invest_join$row_id %in% invest_true$row_id,
        1,
        0
      ),
    # create intervention type flags
    # count # of investments
    n_invest = 
      case_when(
        !is.na(investment_7) ~ 7,
        !is.na(investment_6) ~ 6,
        !is.na(investment_5) ~ 5,
        !is.na(investment_4) ~ 4,
        !is.na(investment_3) ~ 3,
        !is.na(investment_2) ~ 2,
        !is.na(investment_1) ~ 1,
        TRUE                 ~ 0
      ),
    # determine study location
    location =
      case_when(
        str_extract(GEOID, "(?<=06)\\d{3}") == "037" ~ "LA",
        str_extract(GEOID, "(?<=06)\\d{3}") == "019" ~ "Fresno",
        TRUE                                         ~ "SF_Bay"
      )
  ) %>% 
  # convert the NA's in intervention type flags to 0
  mutate_at(vars(greening:transit), ~replace(., is.na(.), 0)) %>% 
  # do not need geometry anymore, drop here
  st_as_sf() %>% 
  st_drop_geometry() %>% 
  #reorder columns
  select(row_id, GEOID, investment, location, everything())
```

# Write master_df (master investments) to csv
```{r}
master_df %>% 
  write_csv(master_df_path)
```

# Read in crosswalked 2009 ACS data
```{r}
acs_tract_09_xwalk <- read_csv(acs_tract_09_xwalk_file)
```

# Investigate difference between GEOID in ACS and master_df 
```{r}
geo_dif <- 
  setdiff(acs_tract_09_xwalk$GEOID, master_df$GEOID) %>% 
  tibble(fips = .) %>% 
  mutate(county = str_extract(fips, "(?<=^\\d{2})\\d{3}"))

# 003 and 005 are Alpine and Amador County - remove them
geo_dif <-
  geo_dif %>% 
  filter(!(county %in% c("003", "005")))

# 007 and 009 are Butte and Calveras County - remove them
geo_dif <-
  geo_dif %>% 
  filter(!(county %in% c("007", "009")))

# 011, 015, 017 are Colusa, Del Norte, and El Dorado Counties - remove them
geo_dif <-
  geo_dif %>% 
  filter(!(county %in% c("011", "015", "017")))

# too many to list individually, filtering out non-Bay/Fresno/LA counties
geo_dif <-
  geo_dif %>% 
  filter(county %in% c("037", "019", sf_bay_area))

# No missing tracts from study area, should be okay to join
```

# Join crosswalked 2009 ACS with master_df
```{r}
master_09_df <-
  master_df %>% 
  left_join(acs_tract_09_xwalk, by = "GEOID")
```

# Filter 2018 ACS data to tracts in master_df
## Read in 2018 ACS
```{r}
acs_tract_18 <- read_csv(acs_tract_18_file)
```

## Filter to correct GEOID
```{r}
# One missing tract from LA
setdiff(master_09_df$GEOID, acs_tract_18$stctytrct)

acs_tract_18_filter <-
  acs_tract_18 %>% 
  filter(stctytrct %in% master_09_df$GEOID)
```

# Write filtered 2018 ACS to CSV
```{r}
acs_tract_18_filter %>% 
  write_csv(acs_tract_18_filter_path)
```

# Filter master_09_df to study variables, join with 2018 data
# NOTE: need to reevaluate variable selection
```{r}
master_09_df <-
  master_09_df %>% 
  # Generate baseline study variables
  mutate(
    # pop nonwhites in 2009
    pop_nonwhi_09 = pop_tot_09 - pop_whi_nonhis_09,
    # percent nonwhites in 2009
    pct_nonwhi_09 = pop_nonwhi_09 / pop_tot_09,
    # % poverty in 2009
    pct_pov_09 = pov_rate_09,
    # % vacant housing units in 2009
    pct_housing_vac_09 = vac_rate_09,
  ) %>% 
  # join with filtered 2018 ACS data
  left_join(acs_tract_18_filter, by = c("GEOID" = "stctytrct")) %>% 
  # generate change over time study variables
  mutate(
    # pct point change in non-whites (2009 to 2018)
    pct_pnt_nonwhi_chng = (1 - pct_whi) - pct_nonwhi_09,
    # pct population change in non-whites (2009 to 2018)
    pct_pop_nonwhi_chng = 
      ((pop_tot - pop_whi_nonhis) - pop_nonwhi_09) / pop_nonwhi_09,
    # pct point change in poverty rate (2009 to 2018)
    pct_pnt_pov_chng = pov_rate - pct_pov_09,
    # pct population change in poverty (2009 to 2018)
    pct_pop_pov_chng = (pop_pov_pov - pop_pov_pov_09) / pop_pov_pov_09,
    # change in median hh income (2009 to 2018)
    med_inc_chng = med_inc - med_inc_09,
    # pct change in median hh income (2009 to 2018)
    pct_med_inc_chng = (med_inc - med_inc_09) / med_inc_09,
    # pct pnt change in vacancy rate (2009 to 2018)
    pct_pnt_vac_chng = vac_rate - pct_housing_vac_09,
    # pct change in vacant housing units (2009 to 2018)
    pct_vac_chng = (housing_vac - housing_vac_09) / housing_vac_09,
    # pct pnt change in renter-occupied units (2009 to 2018)
    pct_pnt_h_rent_chng = pct_h_rent - pct_h_rent_09,
    # pct change in renter-occupied units (2009 to 2018)
    pct_h_rent_chng = (housing_o_rent - housing_o_rent_09) / housing_o_rent_09,
    # change in median gross rent (2009 to 2018)
    med_rent_chng = med_rent - med_rent_09,
    # % change in median gross rent (2009 to 2018
    pct_med_rent_chng = (med_rent - med_rent_09) / med_rent_09,
    # pct pnt change in college-educated (2009 to 2018)
    pct_pnt_college_chng = pct_college - pct_college_09,
    # pct population change in college-educated (2009 to 2018)
    pct_pop_college_chng = (pop_college - pop_college_09) / pop_college_09
  ) %>% 
  # Replace all "Inf" values with NA
  mutate(across(.cols = everything(), na_if, Inf))
```

# Write master_09_df (master investments for 2009/change over time) to csv
```{r}
master_09_df %>% 
  write_csv(master_09_df_path)
```