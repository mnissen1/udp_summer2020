---
title: "SGC Maps"
author: "Matt Alvarez-Nissen"
date: "9/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(sp)
library(tigris)
library(htmlwidgets)
library(leaflet)
options(tigris_use_cache = TRUE)

# Files
## Matched Stats
total_stats_file <- "./SGC/total_stats_all.csv"

## Spatial data
dir <- "./SGC/Spatial Data 06_26_2020"
shp_list <- list.files(dir, pattern = "\\.shp$", full.names = TRUE)

## NOAH
noah_00_xwalk_file <- "./SGC/NOAH_SGC_2000_xwalk.csv"
noah_09_xwalk_file <- "./SGC/NOAH_SGC_2009_xwalk.csv"
noah_16_file <- "./SGC/NOAH_SGC_2016.csv"

## Outmigration
outmigration_tract_file <- "./SGC/outmigration_tract_master.csv"

## ACS
acs_tract_09_xwalk_file <- "./SGC/acs_tract_09_xwalk.csv"
acs_tract_18_file <- "./SGC/acs_tract_18.csv"

# Parameters
## County names
sf_bay_counties <- 
  c(
    "Alameda", "Contra Costa", "Marin", "Napa", "Sacramento", "San Francisco", "San Joaquin", "San Mateo", "Santa Clara", "Santa Cruz", "Solano", "Yolo"
  )
la_county <- "Los Angeles"
fresno_county <- "Fresno"

## file paths to delete (delete points if polygon version exists)
delete_list <-
  c(
    "Albion_Riverside_Park_Point",
    "Cultural_Arts_District_Park_Point",
    "Ed_Roberts_Campus_Point",
    "Granville_Properties_Points",
    "MacArthur_Transit_Village_Points",
    "Gold_Line_Extension_Points",
    "Willowbrook_Rosa_Parks_Station_Point",
    "Mid_City_Expo_LRT_Points",
    "Rumrill_Park_Point",
    "Salud_Park_Point",
    "T_Third_St_LR_Stations_Points",
    "South_Sacramento_Corridor_LR_Extension_Points",
    "Taylor_Yard_Transit_Village_Points",
    "Neighborhood_Types"
  )

## EPSG Code (use 4326 for WGS84)
epsg <- 4326

## GEOID pairs path
geoid_pairs_path <- "./SGC/sgc_geoid_pairs.csv"
```

# Read in tract geometries
```{r}
# Read in tract geometry
study_tracts <-
  tracts(
    state = "CA", 
    county = c(sf_bay_counties, la_county, fresno_county),
    year = 2010
  ) %>% 
  st_as_sf() %>% 
  st_transform(crs = epsg) %>% 
  as_tibble() %>% 
  select(GEOID10, geometry)
```

# Read in study data
```{r}
# Read in NOAH and Outmigration data
total_stats <- 
  read_csv(total_stats_file) %>% 
  # select for relevant variables
  select(
    GEOID, 
    investment,
    distance,
    greening:transit,
    location,
    perc_noah_tot_change,
    perc_noah_nolihtc_change,
    contains("outmigration")
  )
```

# Read in NOAH data
```{r}
# 2000
noah_00_xwalk <- read_csv(noah_00_xwalk_file)
# 2009
noah_09_xwalk <- read_csv(noah_09_xwalk_file)
# 2016
noah_16 <- 
  read_csv(noah_16_file) %>% 
  # filter down to necessary columns
  select(
    GEOID = stctytrct, 
    noah_housing_tot = housing_tot,
    noah_tot_clean,
    noah_nolihtc_clean,
    d_bay,
    d_la, 
    d_fresno
  )
```

# Read in outmigration data
```{r}
outmigration_tract <- read_csv(outmigration_tract_file)
```

# Read in ACS data
```{r}
acs_tract_09_xwalk <- 
  read_csv(acs_tract_09_xwalk_file) %>% 
  # remove the beginning "2000_"
  rename_with(~ str_remove(., "^2000_"), starts_with("2000_"))

acs_tract_18 <- read_csv(acs_tract_18_file)
```

## Join 2009 and 2018 ACS, find change numbers
```{r}
acs_tract_change <-
  acs_tract_09_xwalk %>% 
  # Add baseline 2009 to variables 
  rename_with(~ paste0(.x, "_09"), -GEOID) %>%
  # Create baseline variables
  mutate(
    # % nonwhites in 2009
    pct_nonwhi_09 = 1 - pct_whi_09,
    # pop nonwhites in 2009
    pop_nonwhi_09 = pop_tot_09 - pop_whi_nonhis_09,
    # rename poverty rate 2009
    pct_pov_09 = pov_rate_09,
    # rename housing vacancy rate 2009
    pct_housing_vac_09 = housing_vac_09
  ) %>% 
  # filter to only relevant variables
  select(
    GEOID,
    pct_nonwhi_09, 
    pct_pov_09,
    med_inc_09, 
    pct_housing_vac_09,
    pct_h_rent_09, 
    med_rent_09, 
    pct_college_09
  ) %>% 
  # Replace all "Inf" values with NA
  mutate(across(.cols = everything(), na_if, Inf))
```

# Join all ACS, NOAH, Outmigration data together
```{r}
full_area_info <-
  acs_tract_change %>% 
  # join with 2016 data
  left_join(noah_16, by = "GEOID") %>%
  # clean joined data
  select(-c(d_bay:d_fresno)) %>% 
  rename(
    noah_tot_clean_16 = noah_tot_clean, 
    noah_nolihtc_clean_16 = noah_nolihtc_clean,
    noah_housing_tot_16 = noah_housing_tot
  ) %>% 
  # join with crosswalked 2009 data
  left_join(noah_09_xwalk, by = "GEOID") %>% 
  # find diff in NOAH units
  mutate(
    noah_tot_change = noah_tot_clean_16 - noah_tot_clean_09,
    noah_nolihtc_change = noah_nolihtc_clean_16 - noah_nolihtc_clean_09,
    perc_noah_tot_change = noah_tot_change / noah_tot_clean_09,
    perc_noah_nolihtc_change = noah_nolihtc_change / noah_nolihtc_clean_09
  ) %>% 
  # convert Inf to NA
  mutate(across(.cols = everything(), na_if, Inf)) %>% 
  # join with outmigration data
  left_join(outmigration_tract, by = c("GEOID" = "tract")) %>% 
  # find change in outmigration rates by tract
  group_by(GEOID) %>% 
  mutate(
    outmigration_all_mean = 
      mean(c_across(starts_with("outmigration_all")), na.rm = TRUE),
    outmigration_LI_mean =
      mean(c_across(starts_with("outmigration_LI_2")), na.rm = TRUE),
    outmigration_r_mean =
      mean(c_across(starts_with("outmigration_r")), na.rm = TRUE),
    outmigration_LI_r_mean =
      mean(c_across(starts_with("outmigration_LI_r")), na.rm = TRUE),
  ) %>% 
  ungroup() %>% 
  # Join with tract geometry
  left_join(study_tracts, by = c("GEOID" = "GEOID10")) %>% 
  # add location flag
  mutate(
    location =
      case_when(
        str_detect(GEOID, "^06037") ~ "LA",
        str_detect(GEOID, "^06019") ~ "Fresno",
        TRUE ~ "SF Bay"
      )
  ) %>% 
  st_as_sf() %>% 
  st_transform(crs = epsg)
```

# Join study data with tract geometry and ACS
```{r}
total_stats_geo <-
  total_stats %>% 
  # calculate outmigration rates by tract
  group_by(GEOID) %>% 
  mutate(
    outmigration_all_mean = 
      mean(c_across(starts_with("outmigration_all")), na.rm = TRUE),
    outmigration_LI_mean =
      mean(c_across(starts_with("outmigration_LI_2")), na.rm = TRUE),
    outmigration_r_mean =
      mean(c_across(starts_with("outmigration_r")), na.rm = TRUE),
    outmigration_LI_r_mean =
      mean(c_across(starts_with("outmigration_LI_r")), na.rm = TRUE),
  ) %>% 
  ungroup() %>% 
  # join with ACS data
  left_join(acs_tract_change, by = "GEOID") %>% 
  # join with geometry
  left_join(study_tracts, by = c("GEOID" = "GEOID10")) %>%
  st_as_sf() %>% 
  st_transform(crs = epsg)
```

# Create df with paired GEOIDS
```{r}
paired_geoids <- 
  total_stats_geo %>% 
  group_by(investment) %>% 
  arrange(location, investment, distance) %>% 
  # designate paired neighborhood (census tract)
  mutate(geoid_group = row_number()) %>% 
  ungroup() %>% 
  # join geometry by geoid group
  group_by(geoid_group) %>% 
  mutate(geometry = st_union(geometry)) %>% 
  # drop extra variables
  select(GEOID, geoid_group) %>% 
  group_by(geoid_group) %>% 
  # create paired geoids
  mutate(
    geoid_pair = lead(GEOID, order_by = geoid_group),
    geoid_pair = 
      if_else(is.na(geoid_pair), lag(GEOID, order_by = geoid_group), geoid_pair)
  )
```

# Write GEOID pairs into csv
```{r}
paired_geoids %>% 
  st_drop_geometry() %>%  
  slice(1) %>% 
  ungroup() %>% 
  select(geoid_no_investment = GEOID, geoid_investment = geoid_pair) %>% 
  write_csv(path = geoid_pairs_path) 
```

# Read in geometry of investments
## Filter shp_list
```{r}
# delete points from consideration
# definitely not the most elegant solution...
shp_list <-
  shp_list %>% 
  # turn into df to implement filters
  tibble(full = .) %>% 
  mutate(
    # extract just the name
    short = str_remove(full, dir),
    short = str_remove(short, "/"),
    short = str_remove(short, ".shp"),
    # create flag if name is in delete list
    delete_flag = short %in% delete_list
  ) %>% 
  # filter out delete_list
  filter(delete_flag == FALSE) %>% 
  # return to list format
  pull(full)
```

## Write each investment to separate object
```{r}
#Albion Riverside Park
albion_park <- 
  st_read(shp_list[1]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

#Concord Monument Ped Imprv
concord_ped_imprv <- 
  st_read(shp_list[2]) %>% 
  st_transform(crs = epsg) %>% st_zm() %>% st_cast("LINESTRING")

#Crenshaw Blvd Streetscape
crenshaw_blv_st <- 
  st_read(shp_list[3]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

#cultural arts district park
cultural_arts_park <- 
  st_read(shp_list[4]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# ed roberts campus
ed_roberts_campus <- 
  st_read(shp_list[5]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# el monte transit
el_monte_transit <- 
  st_read(shp_list[6]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# fresno BRT
fresno_brt <-
  st_read(shp_list[7]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# fulton mall
fulton_mall <- 
  st_read(shp_list[8]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# gold line extension
gold_line <- 
  st_read(shp_list[9]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# granville properties
granville_properties <-
  st_read(shp_list[10]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# macarthur transit village
mtv <- 
  st_read(shp_list[11]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# mid city expo LRT
midcity_expo_lrt <- 
  st_read(shp_list[12]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# midtown transportation...
midtown_trans_st_imprv_line <-
  st_read(shp_list[13]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# rumrill park
rumrill_park <- 
  st_read(shp_list[14]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# salud park
salud_park <-
  st_read(shp_list[15]) %>%
  st_transform(crs = epsg) %>% st_zm() 

# san leandro bart
san_leandro_bart <- 
  st_read(shp_list[16]) %>%
  st_transform(crs = epsg) %>% st_zm() 

# south sac phase 2 extension
sac_phase_2 <- 
  st_read(shp_list[17]) %>%
  st_transform(crs = epsg) %>% st_zm() 

# third street LR line
third_st_lr <- 
  st_read(shp_list[18]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# taylor yard transit village
taylor_yard_transit_village <- 
  st_read(shp_list[19]) %>% 
  st_transform(crs = epsg) %>% st_zm() 

# the exchange at el monte
exchange_el_monte <-
  st_read(shp_list[20]) %>% 
  st_transform(crs = epsg) %>% st_zm() %>% st_cast("POINT") 

# willowbrook
willowbrook_station <- 
  st_read(shp_list[21]) %>% 
  st_transform(crs = epsg) %>% st_zm() 
```

# Make leaflet map
TO DO:
* NOAH legend does not go away
** Does not seem to work anymore, attaching just to study area "group"
** Base groups do not yet work with the layerControl yet
** Problem solved: no longer using full NOAH data - doesn't make sense w/
** overall story

* Partner matched GEOIDs
** paired geometries, created separate layer

* Add markers to investments
** done

* change color scale
** done

## Set up parameters for the map
### NOAH parameters
```{r}
#min(full_area_info$perc_noah_tot_change, na.rm = TRUE)
# set noah bins
noah_bins <- 
 round(
   BAMMtools::getJenksBreaks(total_stats_geo$perc_noah_tot_change, k = 10), 2
  )

# include 0 break
noah_bins <- c(noah_bins, 0)
noah_bins <- sort(noah_bins)

# Set study NOAH limits
pal_noah <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from minimum to 1500
     c(
       min(total_stats_geo$perc_noah_tot_change, na.rm = TRUE),
       max(total_stats_geo$perc_noah_tot_change, na.rm = TRUE)
      ),
    #set to custom bins
    bins = noah_bins,
    na.color = "grey"
  )

# Set NOAH labels
## don't forget to slice the final NA label
noah_labs <- 
  head(
    paste(
      scales::percent(noah_bins, 4), 
      scales::percent(lead(noah_bins), 4), 
      sep = " - "
    ), 
    -1
  )
```

### Investment Parameters
```{r}
# create investment factor to color boundaries
invest_pal <-
  colorFactor(
    palette = c("red", "green"),
    domain = total_stats_geo$investment
  )

# set investment labels
invest_labs <- c("No Investment", "Investment")
```

### Outmigration parameters
```{r}
# set outmigration bins (incorporate both study and non study areas)
outmig_bins <- 
 round(
   BAMMtools::getJenksBreaks(total_stats_geo$outmigration_all_mean, k = 10), 2
  )

outmig_bins <- c(outmig_bins, 0, 1)
outmig_bins <- sort(outmig_bins)

# Set outmigration all limits
pal_outmig_all <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from 0 to 1
     c(0, 1),
    #set to custom bins
    bins = outmig_bins,
    na.color = "grey"
  )

# Set Outmigration labels
## don't forget to slice the final NA label
outmig_labs <- 
  head(
    paste(
      scales::percent(outmig_bins), 
      scales::percent(lead(outmig_bins)), 
      sep = " - "
    ),
    -1
  )
```

### Non-white Population Change parameters
```{r}
#min(full_area_info$pct_pnt_nonwhi_chng, na.rm = TRUE)
# set outmigration bins (incorporate both study and non study areas)
nonwhi_bins <- 
 round(
   BAMMtools::getJenksBreaks(full_area_info$pct_pnt_nonwhi_chng, k = 10), 2
  )

# add natural breaks
nonwhi_bins <- c(nonwhi_bins, -1, 0, 1.5)
nonwhi_bins <- sort(nonwhi_bins)
# delete extra breaks
nonwhi_bins <- nonwhi_bins[nonwhi_bins != 0.01]

# Set non-white limits
pal_nonwhi <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from -1 to 2
     c(-1, 2),
    #set to custom bins
    bins = nonwhi_bins,
    na.color = "grey"
  )

# Set non-white labels
## don't forget to slice the final NA label
nonwhi_labs <- 
  head(
    paste(
      scales::percent(nonwhi_bins), 
      scales::percent(lead(nonwhi_bins)), 
      sep = " - "
    ),
    -1
  )
```

### College Educated Change parameters
```{r}
#max(full_area_info$pct_pnt_college_chng, na.rm = TRUE)
# set outmigration bins (incorporate both study and non study areas)
college_bins <- 
 round(
   BAMMtools::getJenksBreaks(full_area_info$pct_pnt_college_chng, k = 10), 2
  )

# add natural breaks
college_bins <- c(college_bins, -1.6, 0, 1)
college_bins <- sort(college_bins)
# remove extra breaks
college_bins <- college_bins[!(college_bins %in% c(-1.57, -.03, .03, .98))]

# Set college limits
pal_college <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from -2 to 1
     c(-2, 1),
    #set to custom bins
    bins = college_bins,
    na.color = "grey"
  )

# Set college labels
## don't forget to slice the final NA label
college_labs <- 
  head(
    paste(
      scales::percent(college_bins), 
      scales::percent(lead(college_bins)), 
      sep = " - "
    ),
    -1
  )
```

### Renter-occupied Change parameters
```{r}
#min(full_area_info$pct_pnt_h_rent_chng, na.rm = TRUE)
# set outmigration bins (incorporate both study and non study areas)
renter_bins <- 
 round(
   BAMMtools::getJenksBreaks(full_area_info$pct_pnt_h_rent_chng, k = 10), 2
  )

# add natural breaks
renter_bins <- c(renter_bins, 0)
renter_bins <- sort(renter_bins)

# Set renter limits
pal_renter <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from -2.5 to 1
     c(-2.5, 1),
    #set to custom bins
    bins = renter_bins,
    na.color = "grey"
  )

# Set renter labels
## don't forget to slice the final NA label
renter_labs <- 
  head(
    paste(
      scales::percent(renter_bins), 
      scales::percent(lead(renter_bins)), 
      sep = " - "
    ),
    -1
  )
```

### Median Rent Change parameters
```{r}
#max(full_area_info$med_rent_chng, na.rm = TRUE)
# set outmigration bins (incorporate both study and non study areas)
medrent_bins <- 
 round(
   BAMMtools::getJenksBreaks(full_area_info$med_rent_chng, k = 10), 0
  )

# add natural breaks
medrent_bins <- c(medrent_bins, 0, 3475)
medrent_bins <- sort(medrent_bins)
medrent_bins <- medrent_bins[medrent_bins != 3474]

# Set median rent limits
pal_medrent <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from -2500 to 3500
     c(-2500, 3500),
    #set to custom bins
    bins = medrent_bins,
    na.color = "grey"
  )

# Set median rent labels
## don't forget to slice the final NA label
medrent_labs <- 
  head(
    paste(
      scales::dollar(medrent_bins), 
      scales::dollar(lead(medrent_bins)), 
      sep = " - "
    ),
    -1
  )
```

### Median Income Change parameters
```{r}
#max(full_area_info$med_inc_chng, na.rm = TRUE)
medinc_bins <- 
 round(
   BAMMtools::getJenksBreaks(full_area_info$med_inc_chng, k = 10), 0
  )

# add natural breaks
medinc_bins <- c(medinc_bins, -160000, 0, 250000)
medinc_bins <- sort(medinc_bins)
medinc_bins <- medinc_bins[!(medinc_bins %in% c(-159910, 249290))]

# Set median income limits
pal_medinc <- 
  colorBin(
    palette = "plasma",
    domain =
    # set domain from -200000 to 250000
     c(-200000, 250000),
    #set to custom bins
    bins = medinc_bins,
    na.color = "grey"
  )

# Set median income labels
## don't forget to slice the final NA label
medinc_labs <- 
  head(
    paste(
      scales::dollar(medinc_bins), 
      scales::dollar(lead(medinc_bins)), 
      sep = " - "
    ),
    -1
  )
```

### Average area parameters (NOAH and outmigration)
```{r}
pal_area_noah <-
  colorFactor(
    palette = c("white", "white", "white"),
    domain = 
      unite(
        total_stats_geo %>%
          group_by(location) %>%
          summarise(
            noah_change = 
              scales::percent(mean(perc_noah_tot_change, na.rm = TRUE), 4)
          ),
        "location_change",
        location,
        noah_change,
        sep = ": "
      ) %>% 
      st_drop_geometry() %>% 
      mutate(location_change = str_replace(location_change, "_", " ")) %>% 
      pull()
  )

# outmigration all
pal_area_outmigration_all <-
  colorFactor(
    palette = c("white", "white", "white"),
    domain = 
      unite(
        total_stats_geo %>%
          group_by(location) %>%
          summarise(
            outmig_change = 
              scales::percent(mean(outmigration_all_mean, na.rm = TRUE), 4)
          ),
        "location_change",
        location,
        outmig_change,
        sep = ": "
      ) %>% 
      st_drop_geometry() %>% 
      mutate(location_change = str_replace(location_change, "_", " ")) %>% 
      pull()
  )

# outmigration LI
pal_area_outmigration_li <-
  colorFactor(
    palette = c("white", "white", "white"),
    domain = 
      unite(
        total_stats_geo %>%
          group_by(location) %>%
          summarise(
            outmig_change = 
              scales::percent(mean(outmigration_LI_mean, na.rm = TRUE), 4)
          ),
        "location_change",
        location,
        outmig_change,
        sep = ": "
      ) %>% 
      st_drop_geometry() %>% 
      mutate(location_change = str_replace(location_change, "_", " ")) %>% 
      pull()
  )

# outmigration renter
pal_area_outmigration_r <-
  colorFactor(
    palette = c("white", "white", "white"),
    domain = 
      unite(
        total_stats_geo %>%
          group_by(location) %>%
          summarise(
            outmig_change = 
              scales::percent(mean(outmigration_r_mean, na.rm = TRUE), 4)
          ),
        "location_change",
        location,
        outmig_change,
        sep = ": "
      ) %>% 
      st_drop_geometry() %>% 
      mutate(location_change = str_replace(location_change, "_", " ")) %>% 
      pull()
  )

# outmigration LI r
pal_area_outmigration_li_r <-
  colorFactor(
    palette = c("white", "white", "white"),
    domain = 
      unite(
        total_stats_geo %>%
          group_by(location) %>%
          summarise(
            outmig_change = 
              scales::percent(mean(outmigration_LI_r_mean, na.rm = TRUE), 4)
          ),
        "location_change",
        location,
        outmig_change,
        sep = ": "
      ) %>% 
      st_drop_geometry() %>% 
      mutate(location_change = str_replace(location_change, "_", " ")) %>% 
      pull()
  )
```


### Overlays
```{r}
# Set overlay groups
overlay_groups <-
  c(
    "Census Boundaries", 
    "Investments",
    "Investment Tract Flag",
    "Non-white Population",
    "College Educated Population",
    "Renter-Occupied Housing",
    "Median Rent",
    "Median Income",
    "NOAH Study Areas", 
    "Outmigration All Study Areas",
    "Outmigration LI Study Areas",
    "Outmigration Renter Study Areas",
    "Outmigration LI Renter Study Areas"
  )
```

## Create dollar sign marker for investments
```{r}
dollar_icon <- makeAwesomeIcon(
  icon = "dollar",
  iconColor = "black",
  library = "fa",
  markerColor = "orange"
)
```

# Generate leaflet map
```{r}
my_map <-
# leaflet setup ######################################
  leaflet(options = leafletOptions(minZoom = 6, maxZoom = 18)) %>% 
  addTiles(options = tileOptions(minZoom = 6, maxZoom = 18)) %>% 
  
  # Set Provider Tile ##################
  addProviderTiles(
    provider = "CartoDB.Positron",
    options = tileOptions(minZoom = 6, maxZoom = 18)
  ) %>%
  
  # Set Maximum Bounds for California #####################
  setMaxBounds(
    lat1 = 32.5121,
    lat2 = 42.0126,
    lng1 = -124.6509,
    lng2 = -114.1315
  ) %>% 
  
  # Add layers #################################################################
  ## add NOAH % change in study areas polygon ##################
  addPolygons(
    data = total_stats_geo,
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display NOAH change
        "% NOAH Change:", 
        scales::percent(total_stats_geo$perc_noah_tot_change, 4), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
    # set fill colors
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_noah(perc_noah_tot_change),
    group = "NOAH Study Areas",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## add Total Outmigration study areas polygon ####################
  addPolygons(
     # set outmigration data
    data = total_stats_geo,
   # set popups for geoid, data, investment type
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display Average Outmigration Rates
        "Average Total Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_all_mean, 4), "<br>",
        "Average Low Income Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_mean, 4), "<br>",
        "Average Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_r_mean, 4), "<br>",
        "Average Low Income Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_r_mean, 4), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_outmig_all(outmigration_all_mean),
    group = "Outmigration All Study Areas",
   # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## add LI Outmigration study areas polygon #########################
  addPolygons(
     # set outmigration data
    data = total_stats_geo,
   # set popups for geoid, data, investment type
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display Average Outmigration Rates
        "Average Total Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_all_mean, 4), "<br>",
        "Average Low Income Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_mean, 4), "<br>",
        "Average Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_r_mean, 4), "<br>",
        "Average Low Income Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_r_mean, 4), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_outmig_all(outmigration_LI_mean),
    group = "Outmigration LI Study Areas",
   # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## add Renter Outmigration study areas polygon ####################
  addPolygons(
     # set outmigration data
    data = total_stats_geo,
   # set popups for geoid, data, investment type
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display Average Outmigration Rates
        "Average Total Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_all_mean, 4), "<br>",
        "Average Low Income Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_mean, 4), "<br>",
        "Average Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_r_mean, 4), "<br>",
        "Average Low Income Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_r_mean, 4), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_outmig_all(outmigration_r_mean),
    group = "Outmigration Renter Study Areas",
   # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%

  ## add LI Renter Outmigration study areas polygon ######################
  addPolygons(
     # set outmigration data
    data = total_stats_geo,
   # set popups for geoid, data, investment type
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display Average Outmigration Rates
        "Average Total Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_all_mean, 4), "<br>",
        "Average Low Income Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_mean, 4), "<br>",
        "Average Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_r_mean, 4), "<br>",
        "Average Low Income Renter Outmigration Rate:",
        scales::percent(total_stats_geo$outmigration_LI_r_mean, 4), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
   smoothFactor = 0,
   fillOpacity = .7,
   weight = 0,
   color = ~pal_outmig_all(outmigration_LI_r_mean),
   group = "Outmigration LI Renter Study Areas",
   # bring shape to front on hover
   highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## Add Non-white population change ##############################
  addPolygons(
    # set population data
    data = full_area_info,
    # set popups for geoid, data
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(full_area_info$GEOID), "<br>",
        
        # Display non-white population change
        "Percentage Point Non-white Population Change:",
        scales::percent(full_area_info$pct_pnt_nonwhi_chng, 4), "<br>",
        
        # Display college educated change
        "Percentage Point College Educated Population Change:",
        scales::percent(full_area_info$pct_pnt_college_chng, 4), "<br>",
        
        # Display renter occupied housing change
        "Percentage Point Renter-Occupied Housing Change:",
        scales::percent(full_area_info$pct_pnt_h_rent_chng, 4), "<br>",
        
        # Display median rent change
        "Median Rent Change:",
        scales::dollar(full_area_info$med_rent_chng, 4), "<br>",
        
        # Display median income change
        "Median Income Change:",
        scales::dollar(full_area_info$med_inc_chng, 4)
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_nonwhi(pct_pnt_nonwhi_chng),
    group = "Non-white Population",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## Add College population change #############################
  addPolygons(
    # set population data
    data = full_area_info,
    # set popups for geoid, data
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(full_area_info$GEOID), "<br>",
        
        # Display non-white population change
        "Percentage Point Non-white Population Change:",
        scales::percent(full_area_info$pct_pnt_nonwhi_chng, 4), "<br>",
        
        # Display college educated change
        "Percentage Point College Educated Population Change:",
        scales::percent(full_area_info$pct_pnt_college_chng, 4), "<br>",
        
        # Display renter occupied housing change
        "Percentage Point Renter-Occupied Housing Change:",
        scales::percent(full_area_info$pct_pnt_h_rent_chng, 4), "<br>",
        
        # Display median rent change
        "Median Rent Change:",
        scales::dollar(full_area_info$med_rent_chng, 4), "<br>",
        
        # Display median income change
        "Median Income Change:",
        scales::dollar(full_area_info$med_inc_chng, 4)
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_college(pct_pnt_college_chng),
    group = "College Educated Population",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## Add renter-occupied housing change ##########################
  addPolygons(
    # set population data
    data = full_area_info,
    # set popups for geoid, data
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(full_area_info$GEOID), "<br>",
        
        # Display non-white population change
        "Percentage Point Non-white Population Change:",
        scales::percent(full_area_info$pct_pnt_nonwhi_chng, 4), "<br>",
        
        # Display college educated change
        "Percentage Point College Educated Population Change:",
        scales::percent(full_area_info$pct_pnt_college_chng, 4), "<br>",
        
        # Display renter occupied housing change
        "Percentage Point Renter-Occupied Housing Change:",
        scales::percent(full_area_info$pct_pnt_h_rent_chng, 4), "<br>",
        
        # Display median rent change
        "Median Rent Change:",
        scales::dollar(full_area_info$med_rent_chng, 4), "<br>",
        
        # Display median income change
        "Median Income Change:",
        scales::dollar(full_area_info$med_inc_chng, 4)
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_renter(pct_pnt_h_rent_chng),
    group = "Renter-Occupied Housing",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## Add median rent change ##################################
  addPolygons(
    # set population data
    data = full_area_info,
    # set popups for geoid, data
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(full_area_info$GEOID), "<br>",
        
        # Display non-white population change
        "Percentage Point Non-white Population Change:",
        scales::percent(full_area_info$pct_pnt_nonwhi_chng, 4), "<br>",
        
        # Display college educated change
        "Percentage Point College Educated Population Change:",
        scales::percent(full_area_info$pct_pnt_college_chng, 4), "<br>",
        
        # Display renter occupied housing change
        "Percentage Point Renter-Occupied Housing Change:",
        scales::percent(full_area_info$pct_pnt_h_rent_chng, 4), "<br>",
        
        # Display median rent change
        "Median Rent Change:",
        scales::dollar(full_area_info$med_rent_chng, 4), "<br>",
        
        # Display median income change
        "Median Income Change:",
        scales::dollar(full_area_info$med_inc_chng, 4)
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_medrent(med_rent_chng),
    group = "Median Rent",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## Add median income change ##############################
  addPolygons(
    # set population data
    data = full_area_info,
    # set popups for geoid, data
    # Set GEOID names and NOAH percentages
    popup = 
      paste(
        # Display Tract number
        "Census Tract:", as.character(full_area_info$GEOID), "<br>",
        
        # Display non-white population change
        "Percentage Point Non-white Population Change:",
        scales::percent(full_area_info$pct_pnt_nonwhi_chng, 4), "<br>",
        
        # Display college educated change
        "Percentage Point College Educated Population Change:",
        scales::percent(full_area_info$pct_pnt_college_chng, 4), "<br>",
        
        # Display renter occupied housing change
        "Percentage Point Renter-Occupied Housing Change:",
        scales::percent(full_area_info$pct_pnt_h_rent_chng, 4), "<br>",
        
        # Display median rent change
        "Median Rent Change:",
        scales::dollar(full_area_info$med_rent_chng, 4), "<br>",
        
        # Display median income change
        "Median Income Change:",
        scales::dollar(full_area_info$med_inc_chng, 4)
      ),
    smoothFactor = 0,
    fillOpacity = .7,
    weight = 0,
    color = ~pal_medinc(med_inc_chng),
    group = "Median Income",
    # bring shape to front on hover
    highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
  ) %>%
  
  ## add census boundaries #################
  addPolylines(
    data = study_tracts$geometry,
    # set border color
    color = "black",
    weight = 1,
    fillOpacity = 0,
    group = "Census Boundaries"
  ) %>%
  
## add investment boundaries ###############################
  addPolylines(
    data = total_stats_geo,
    # set investment borders
    stroke = TRUE,
    color = ~ invest_pal(investment),
    opacity = 1,
    fillColor = NULL,
    fillOpacity = 0,
    weight = 1.5,
    group = "Investment Tract Flag",
    popup = 
      paste(
        # add tract's GEOID
        "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
        
        # Display investment flags by type
        "Investment Types: ", 
        case_when(
          # all 4
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Urban Infill, Active Transportation",
          # 3 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Transit, Active Transportation",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Urban Infill, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Urban Infill, Active Transportation",
          # 2 investment types
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Transit",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Greening, Urban Infill",
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Greening, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Transit, Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Transit, Active Transportation",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 1 ~
            "Urban Infill, Active Transportation",
          # single investments
          total_stats_geo$greening == 1 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Greening",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 1 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 0 ~
            "Transit",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 1 &
            total_stats_geo$active_transportation == 0 ~
            "Urban Infill",
          total_stats_geo$greening == 0 &
            total_stats_geo$transit == 0 &
            total_stats_geo$urban_infill == 0 &
            total_stats_geo$active_transportation == 1 ~
            "Active Transportation",
          TRUE ~ "No Investments"
        )
      ),
    highlightOptions = highlightOptions(weight = 6, bringToFront = TRUE)
  ) %>%
  ## add investment pairs
  addPolygons(
    data = paired_geoids,
    # set investment borders
    stroke = TRUE,
    color = NA,
    opacity = 1,
    fillColor = "white",
    fillOpacity = .1,
    weight = 0,
    group = "Investment Tract Flag",
    popup = 
      paste(
        # add investment tract's GEOID
        "Investment Tract:", as.character(paired_geoids$GEOID), "<br>",
        # add paired tract
        "Non-Investment Tract:", as.character(paired_geoids$geoid_pair)
      ),
    highlightOptions = highlightOptions(
      fillColor = "green", 
      fillOpacity = .8, 
      stroke = 4, 
      weight = 0, 
      bringToFront = TRUE
      )
  ) %>%

# Add Investment Shapefiles #######################################
## LA INVESTMENTS ###########################################
  ## albion park 
  addPolygons(
    data = albion_park,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup = 
      paste(
        "Albion Riverside Park", "<br>",
        "Investment Type: Greening"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>% 
  ## albion park marker
  addAwesomeMarkers(
    data = albion_park %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 20),
    clusterId = "LA",
    popup =
      paste(
        "Albion Riverside Park", "<br>",
        "Investment Type: Greening"
      )
  ) %>%
  
  ## crenshaw blvd streetscape
  addPolygons(
    data = crenshaw_blv_st,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Crenshaw Boulevard Streetscape Plan", "<br>",
        "Investment Type: Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## crenshaw marker
  addAwesomeMarkers(
    data = crenshaw_blv_st %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 15),
    clusterId = "LA",
    popup =
      paste(
        "Crenshaw Boulevard Streetscape Plan", "<br>",
        "Investment Type: Active Transportation"
      )
  ) %>%
  
  ## el monte transit village
  addPolygons(
    data = el_monte_transit,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "El Monte Transit Village", "<br>",
        "Investment Type: Greening, Urban Infill"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## el monte transit
  addAwesomeMarkers(
    data = el_monte_transit %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "LA",
    popup =
      paste(
        "El Monte Transit Village", "<br>",
        "Investment Type: Greening, Urban Infill"
      )
  ) %>%

  ## gold line extension
  addPolylines(
    data = gold_line,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Metro Gold Line Foothill Extension", "<br>",
        "Investment Type: Transit, Urban Infill"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## gold line marker
  addAwesomeMarkers(
    data = gold_line %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "LA",
    popup =
      paste(
        "Metro Gold Line Foothill Extension", "<br>",
        "Investment Type: Transit, Urban Infill"
      )
  ) %>% 

  ## mid city expo lrt
  addPolylines(
    data = midcity_expo_lrt,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Mid City/Expo LRT", "<br>",
        "Investment Type: Transit"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## mid city expo lrt
  addAwesomeMarkers(
    data = midcity_expo_lrt %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 15),
    clusterId = "LA",
    popup =
      paste(
        "Mid City/Expo LRT", "<br>",
        "Investment Type: Transit"
      )
  ) %>%
  
  ## salud park
  addPolygons(
    data = salud_park,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Salud Park", "<br>",
        "Investment Type: Greening"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## salud marker
  addAwesomeMarkers(
    data = salud_park %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "LA",
    popup =
      paste(
        "Salud Park", "<br>",
        "Investment Type: Greening"
      )
  ) %>% 
  
  
  ## taylor transit yard
  addPolygons(
    data = taylor_yard_transit_village,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Taylor Yard Transit Village Master Plan", "<br>",
        "Investment Type: Urban Infill"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## taylor transit marker
  addAwesomeMarkers(
    data = 
      taylor_yard_transit_village %>% 
      filter(Name == "Taylor Yard Transit Village") %>% 
      st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 20),
    clusterId = "LA",
    popup =
      paste(
        "Taylor Yard Transit Village Master Plan", "<br>",
        "Investment Type: Urban Infill"
      )
  ) %>% 

  ## exchange at el monte
  addCircles(
    data = exchange_el_monte,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "The Exchange at El Monte - El Monte Transit Village",
        "<br>", "Investment Type: Greening, Urban Infill"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  
  ## Willowbrook Station
  addPolygons(
    data = willowbrook_station,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup = 
      paste(
        "Metro Willowbrook/Rosa Parks Station Improvements", "<br>",
        "Investment Type: Transit, Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>% 
  ## willowbrook marker
  addAwesomeMarkers(
    data = willowbrook_station %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "LA",
    popup = 
      paste(
        "Metro Willowbrook/Rosa Parks Station Improvements", "<br>",
        "Investment Type: Transit, Active Transportation"
      )
  ) %>% 
  
  ## SF BAY INVESTMENTS ########################
  ## concord monument blvd
  addPolylines(
    data = concord_ped_imprv,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Monument Corridor Pedestrian Infrastructure Improvement Project",
        "<br>", "Investment Type: Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## concord monument marker
  addAwesomeMarkers(
    data = concord_ped_imprv %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "Monument Corridor Pedestrian Infrastructure Improvement Project",
        "<br>", "Investment Type: Active Transportation"
      )
  ) %>%

  ## ed roberts campus
  addPolygons(
    data = ed_roberts_campus,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Ed Roberts Campus", "<br>",
        "Investment Type: Urban Infill, Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## ed roberts
  addAwesomeMarkers(
    data = ed_roberts_campus %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 10),
    clusterId = "SF",
    popup =
      paste(
        "Ed Roberts Campus", "<br>",
        "Investment Type: Urban Infill, Active Transportation"
      )
  ) %>%

  ## macarthur transit village
  addPolygons(
    data = mtv,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "MacArthur Transit Village", "<br>",
        "Investment Type: Urban Infill, Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## macarthur transit marker
  addAwesomeMarkers(
    data = 
      mtv %>% 
      filter(Name == "MTV: Mural Affordable Housing Polygon") %>% 
      st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 10),
    clusterId = "SF",
    popup =
      paste(
        "MacArthur Transit Village", "<br>",
        "Investment Type: Urban Infill, Active Transportation"
      )
  ) %>% 

  ## midtown transportation and st imprv
  addPolylines(
    data = midtown_trans_st_imprv_line,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Midtown Transportation and Streetscape Improvements", "<br>",
        "Investment Type: Greening, Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## midtown... marker
  addAwesomeMarkers(
    data = midtown_trans_st_imprv_line %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "Midtown Transportation and Streetscape Improvements", "<br>",
        "Investment Type: Greening, Active Transportation"
      )
  ) %>% 

  ## rumrill park
  addPolygons(
    data = rumrill_park,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Rumrill Park", "<br>",
        "Investment Type: Greening"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## rumrill marker
  addAwesomeMarkers(
    data = rumrill_park %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "Rumrill Park", "<br>",
        "Investment Type: Greening"
      )
  ) %>% 

  ## san leandro dt bart
  addPolylines(
    data = san_leandro_bart,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "San Leandro Downtown-BART Pedestrian Interface", "<br>",
        "Investment Type: Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## san leandro bart marker
  addAwesomeMarkers(
    data = san_leandro_bart %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "San Leandro Downtown-BART Pedestrian Interface", "<br>",
        "Investment Type: Active Transportation"
      )
  ) %>% 

  ## south sac lrt extension
  addPolylines(
    data = sac_phase_2,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "South Sacramento Corridor Light Rail Extension", "<br>",
        "Investment Type: Transit"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## south sac lrt marker
  addAwesomeMarkers(
    data = sac_phase_2 %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "South Sacramento Corridor Light Rail Extension", "<br>",
        "Investment Type: Transit"
      )
  ) %>% 

  # third st lr line
  addPolylines(
    data = third_st_lr,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "SFMTA Third Street Light Rail", "<br>",
        "Investment Type: Transit"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## 3rd st lrt marker
  addAwesomeMarkers(
    data = third_st_lr %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "SF",
    popup =
      paste(
        "SFMTA Third Street Light Rail", "<br>",
        "Investment Type: Transit"
      )
  ) %>% 
  
  ## FRESNO INVESTMENTS ##################################
## cultural arts district park
  addPolygons(
    data = cultural_arts_park,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Cultural Arts District Park", "<br>",
        "Investment Type: Greening"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## cultural arts marker
  addAwesomeMarkers(
    data = cultural_arts_park %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 10),
    clusterId = "Fresno",
    popup =
      paste(
        "Cultural Arts District Park", "<br>",
        "Investment Type: Greening"
      )
  ) %>%
  
  ## fresno BRT line
  addPolylines(
    data = fresno_brt,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "BRT Improvements (Line Q)", "<br>",
        "Investment Type: Transit"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## fresno brt
  addAwesomeMarkers(
    data = fresno_brt %>% st_point_on_surface(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 250),
    clusterId = "Fresno",
    popup =
      paste(
        "BRT Improvements (Line Q)", "<br>",
        "Investment Type: Transit"
      )
  ) %>%

  ## fulton mall
  addPolygons(
    data = fulton_mall,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
        "Fulton Mall Reconstruction Project", "<br>",
        "Investment Type: Active Transportation"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## fulton mall
  addAwesomeMarkers(
    data = fulton_mall %>% st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(maxClusterRadius = 10),
    clusterId = "Fresno",
    popup =
      paste(
        "Fulton Mall Reconstruction Project", "<br>",
        "Investment Type: Active Transportation"
      )
  ) %>% 
  
  ## Granville properties
  addPolygons(
    data = granville_properties,
    stroke = TRUE,
    opacity = 1,
    fillColor = "orange",
    color = "black",
    fillOpacity = 1,
    weight = 4,
    popup =
      paste(
       str_remove(granville_properties$Name, "Polygon"), "<br>",
        "Granville Properties", "<br>",
        "Investment Type: Urban Infill"
      ),
    highlightOptions = highlightOptions(color = "white", bringToFront = TRUE),
    group = "Investments"
  ) %>%
  ## granville property marker
  addAwesomeMarkers(
    data = 
      granville_properties %>% 
      filter(Name == "The Lede Polygon") %>% 
      st_centroid(),
    group = "Investments",
    icon = dollar_icon,
    clusterOptions = markerClusterOptions(),
    clusterId = "Fresno",
    popup =
      paste(
        "Granville Properties", "<br>",
        "Investment Type: Urban Infill"
      )
  ) %>% 
  
## ADD LEGENDS #################################################################
  ## Add Investment Flag legend #####
  addLegend(
    "bottomright", 
    pal = invest_pal, 
    values = total_stats_geo$investment,
    title = "Investment Type",
    labFormat = 
      function(type, cuts, p) {  # Here's the trick
        paste0(invest_labs)
      },
    opacity = 1,
    group = "Investment Tract Flag"
  ) %>% 
  
  ## Add average area NOAH legend###################
addLegend(
  pal = pal_area_noah,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          noah_change = 
            scales::percent(mean(perc_noah_tot_change, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      noah_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average NOAH Change 2009 - 2016",
  opacity = 1,
  group = "NOAH Study Areas"
) %>%
  
  ## Add NOAH legend ######################################
addLegend(
  "bottomleft",
  pal = pal_noah,
  values = full_area_info$perc_noah_tot_change,
    title = "% NOAH Change 2009 - 2016",
    labFormat = 
      function(type, cuts, p) {  # Here's the trick
        paste0(noah_labs)
      },
    opacity = 1,
    group = "NOAH Study Areas"
  ) %>% 
  
  ## Add average area outmigration all legend###################
addLegend(
  pal = pal_area_outmigration_all,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          outmig_change = 
            scales::percent(mean(outmigration_all_mean, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      outmig_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average Total Outmigration Rate 2007 - 2018",
  opacity = 1,
  group = "Outmigration All Study Areas"
) %>%

  ## Add Outmigration All legend ####################################
  addLegend(
    "bottomleft",
    pal = pal_outmig_all,
    values = full_area_info$outmigration_all_mean,
    title = "Average Total Outmigration Rate 2007 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(outmig_labs)
      },
    opacity = 1,
    group = "Outmigration All Study Areas"
  ) %>%
  
  ## Add average area outmigration LI legend###################
addLegend(
  pal = pal_area_outmigration_li,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          outmig_change = 
            scales::percent(mean(outmigration_LI_mean, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      outmig_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average Low Income Outmigration Rate 2007 - 2018",
  opacity = 1,
  group = "Outmigration LI Study Areas"
) %>%
  
  ## Add Outmigration LI legend ##################################
  addLegend(
    "bottomleft",
    pal = pal_outmig_all,
    values = full_area_info$outmigration_LI_mean,
    title = "Average Low Income Outmigration Rate 2007 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(outmig_labs)
      },
    opacity = 1,
    group = "Outmigration LI Study Areas"
  ) %>%

  ## Add average area outmigration renter legend###################
addLegend(
  pal = pal_area_outmigration_r,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          outmig_change = 
            scales::percent(mean(outmigration_r_mean, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      outmig_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average Renter Outmigration Rate 2007 - 2018",
  opacity = 1,
  group = "Outmigration Renter Study Areas"
) %>%
  
  ## Add Outmigration Renter legend ###################################
  addLegend(
    "bottomleft",
    pal = pal_outmig_all,
    values = full_area_info$outmigration_r_mean,
    title = "Average Renter Outmigration Rate 2007 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(outmig_labs)
      },
    opacity = 1,
    group = "Outmigration Renter Study Areas"
  ) %>%

  ## Add average area outmigration LI renter legend###################
addLegend(
  pal = pal_area_outmigration_li_r,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          outmig_change = 
            scales::percent(mean(outmigration_LI_r_mean, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      outmig_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average Low Income Renter Outmigration Rate 2007 - 2018",
  opacity = 1,
  group = "Outmigration LI Renter Study Areas"
) %>%
  
  ## Add Outmigration LI Renter legend #####################################
  addLegend(
    "bottomleft",
    pal = pal_outmig_all,
    values = full_area_info$outmigration_LI_r_mean,
    title = "Average Low Income Renter Outmigration Rate 2007 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(outmig_labs)
      },
    opacity = 1,
    group = "Outmigration LI Renter Study Areas"
  ) %>%
    
  ## Add Non-white population change legend ###############################
  addLegend(
    "bottomleft",
    pal = pal_nonwhi,
    values = full_area_info$pct_pnt_nonwhi_chng,
    title = "Percentage Point Non-white Population Change 2009 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(nonwhi_labs)
      },
    opacity = 1,
    group = "Non-white Population"
  ) %>%
  
  ## Add college population change legend ################################
  addLegend(
    "bottomleft",
    pal = pal_college,
    values = full_area_info$pct_pnt_college_chng,
    title = "Percentage Point College Educated Population Change 2009 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(college_labs)
      },
    opacity = 1,
    group = "College Educated Population"
  ) %>%
  
  ## Add renter occupied change legend ###############################
  addLegend(
    "bottomleft",
    pal = pal_renter,
    values = full_area_info$pct_pnt_h_rent_chng,
    title = "Percentage Point Renter-Occupied Housing Change 2009 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(renter_labs)
      },
    opacity = 1,
    group = "Renter-Occupied Housing"
  ) %>%
  
  ## Add median rent change legend ##################################
  addLegend(
    "bottomleft",
    pal = pal_medrent,
    values = full_area_info$med_rent_chng,
    title = "Median Rent Change 2009 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(medrent_labs)
      },
    opacity = 1,
    group = "Median Rent"
  ) %>%
  
  ## Add median income change legend ##################################
  addLegend(
    "bottomleft",
    pal = pal_medinc,
    values = full_area_info$med_inc_chng,
    title = "Median Income Change 2009 - 2018",
    labFormat =
      function(type, cuts, p) {  # Here's the trick
        paste0(medinc_labs)
      },
    opacity = 1,
    group = "Median Income"
  ) %>%

# Finalize the map #############################################################
  ## Layers control
  addLayersControl(
    overlayGroups = overlay_groups,
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  
  ## Hide layers by default
  hideGroup(overlay_groups) %>% 
  
  ## Add button to set zoom level
  addEasyButton(
    easyButton(
      icon = "fa-globe",
      title = "Zoom out to California",
      # Set to min zoom level
      onClick = JS("function(btn, map){ map.setZoom(6); }")
    )
  )
```

# Save map to html
```{r}
htmlwidgets::saveWidget(my_map, "map_draftFinal3.html", selfcontained = FALSE)
```

* NOTE: could not save as self-contained - my (Matt's) laptop does not have enough memory to handle it

# test plotting
## Create dollar sign marker for investments
```{r}
dollar_icon <- makeAwesomeIcon(
  icon = "dollar",
  iconColor = "black",
  library = "fa",
  markerColor = "orange"
)
```

```{r test-plot}
test_map <-
  # leaflet setup
  leaflet(options = leafletOptions(minZoom = 6, maxZoom = 18)) %>% 
  addTiles(options = tileOptions(minZoom = 6, maxZoom = 18)) %>% 
  
  # Set Provider Tile
  addProviderTiles(
    provider = "CartoDB.Positron",
    options = tileOptions(minZoom = 6, maxZoom = 18)
  ) %>%
  
  # Set Maximum Bounds for California
  setMaxBounds(
    lat1 = 32.5121,
    lat2 = 42.0126,
    lng1 = -124.6509,
    lng2 = -114.1315
  ) %>% 
  
  ## add NOAH % change in study areas polygon ##################
addPolygons(
  data = total_stats_geo,
  # Set GEOID names and NOAH percentages
  popup = 
    paste(
      # Display Tract number
      "Census Tract:", as.character(total_stats_geo$GEOID), "<br>",
      
      # Display NOAH change
      "Tract NOAH Change:", 
      scales::percent(total_stats_geo$perc_noah_tot_change, 4), "<br>",
      
      # Display investment flags by type
      "Investment Types: ", 
      case_when(
        # all 4
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 1 ~
          "Greening, Transit, Urban Infill, Active Transportation",
        # 3 investment types
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 0 ~
          "Greening, Transit, Urban Infill",
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 1 ~
          "Greening, Transit, Active Transportation",
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 1 ~
          "Greening, Urban Infill, Active Transportation",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 1 ~
          "Transit, Urban Infill, Active Transportation",
        # 2 investment types
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 0 ~
          "Greening, Transit",
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 0 ~
          "Greening, Urban Infill",
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 1 ~
          "Greening, Active Transportation",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 0 ~
          "Transit, Urban Infill",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 1 ~
          "Transit, Active Transportation",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 1 ~
          "Urban Infill, Active Transportation",
        # single investments
        total_stats_geo$greening == 1 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 0 ~
          "Greening",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 1 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 0 ~
          "Transit",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 1 &
          total_stats_geo$active_transportation == 0 ~
          "Urban Infill",
        total_stats_geo$greening == 0 &
          total_stats_geo$transit == 0 &
          total_stats_geo$urban_infill == 0 &
          total_stats_geo$active_transportation == 1 ~
          "Active Transportation",
        TRUE ~ "No Investments"
      )
    ),
  # set fill colors
  smoothFactor = 0,
  fillOpacity = .7,
  weight = 0,
  color = ~pal_noah(perc_noah_tot_change),
  group = "NOAH Study Areas",
  # bring shape to front on hover
  highlightOptions = highlightOptions(opacity = 0, bringToFront = FALSE)
) %>%
  
  # ADD LEGENDS
  ################################################################################# Add area NOAH legend
addLegend(
  pal = pal_area_noah,
  "bottomleft",
  values = 
    unite(
      total_stats_geo %>%
        group_by(location) %>%
        summarise(
          noah_change = 
            scales::percent(mean(perc_noah_tot_change, na.rm = TRUE), 4)
        ),
      "location_change",
      location,
      noah_change,
      sep = ": "
    ) %>% 
    st_drop_geometry() %>% 
    mutate(location_change = str_replace(location_change, "_", " ")) %>% 
    pull(),
  title = "Average NOAH Change 2009 - 2016",
  opacity = 1,
  group = "NOAH Study Areas"
) %>%
  
  ## Add NOAH legend ######################################
addLegend(
  "bottomleft",
  pal = pal_noah,
  values = full_area_info$perc_noah_tot_change,
  title = "% NOAH Change 2009 - 2016",
  labFormat = 
    function(type, cuts, p) {  # Here's the trick
      paste0(noah_labs)
    },
  opacity = 1,
  group = "NOAH Study Areas"
) %>% 
  
  # Finalize the map
  ###############################################################################
## Layers control
addLayersControl(
  overlayGroups = overlay_groups,
  options = layersControlOptions(collapsed = TRUE)
) %>% 
  
  ## Hide layers by default
  hideGroup(overlay_groups)
```



# OLD CODE BELOW
```{r}
# sf attempt
total_stats_geo %>% 
  filter(location == "LA") %>% 
  ggplot() +
  geom_sf(aes(fill = perc_noah_tot_change)) +
  #geom_sf(data = la_tracts, fill = NA) +
  coord_sf(ylim = c(33.7, 34.8))
```


```{r}
# Mapview attempt
total_stats_geo %>% 
  filter(location == "LA") %>% 
  mapview(zcol = "perc_noah_tot_change") +
  mapview(albion_park, color = "red") +
  mapview(crenshaw_blv_st) +
  mapview(el_monte_transit) +
  mapview(midcity_expo_lrt) +
  mapview(gold_line) +
  mapview(salud_park) +
  mapview(taylor_yard_transit_village) +
  mapview(exchange_el_monte) +
  mapview(willowbrook_station)
```

